define(["require","exports","../context/Context","../context/Topic","./Layout","../map/Views","esri/config","esri/identity/IdentityManager","esri/request","esri/portal/Portal","esri/identity/OAuthInfo","esri/views/support/WebGLRequirements","esri/core/promiseUtils","dojo/sniff","dojo/dom-construct"],function(e,t,a,i,s,c,u,l,p,d,f,o,n,r,h){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var g=function(){function e(){this._ok=!0}return e.prototype.checkBrowser=function(){var n=a.default.getInstance(),e=o.check();e&&(a.default.getInstance().supports3D=!1,"webgl:major-performance-caveat-detected"===e.name?console.warn("Your browser isn't using hardware acceleration for rendering"):console.warn("Your browser doesn't seem to support WebGL"));var t=!!window.MSInputMethodContext&&!!document.documentMode;(r("ie")||t)&&(this._ok=!1,function(){var e=n.i18n,t=(e.messages.browserNotSupported,h.create("div",{style:{padding:"20px"}}));if(h.create("div",{innerHTML:e.messages.browserNotSupported},t),n.config&&n.config.supportedBrowsersUrl){var o=a.default.checkMixedContent(n.config.supportedBrowsersUrl);h.create("a",{href:o,innerHTML:e.messages.browserNotSupported2},t)}document.body.appendChild(t)}())},e.prototype.checkLicense=function(e,r){return n.create(function(o,n){var e=encodeURIComponent(r.id);r.id||(e=encodeURIComponent("0123456789ABCDEF"));var t=r.restUrl;p(t+="/portals/"+e+"/subscriptionInfo",{query:{f:"json"},method:"get",responseType:"json"}).then(function(e){var t=!1;e&&e.data&&e.data.orgCapabilities&&0<e.data.orgCapabilities.length&&(t=e.data.orgCapabilities.some(function(e){return e&&"indoors"===e.id})),t?o(t):n("__noIndoorsSubscription__")}).catch(function(e){n(e)})})},e.prototype.checkSignIn=function(){var n=this,t=a.default.getInstance(),r=t.config.portalUrl,o=t.getSharingUrl(),i=new f({appId:t.config.oauthAppId,portalUrl:t.config.portalUrl,popup:!1});l.registerOAuthInfos([i]),l.checkSignInStatus(o).then(function(e){t.config.allowAnonymousAccess?n.openApp():n.openApp("immediate")}).catch(function(e){t.config.allowAnonymousAccess?(i.popup&&l.on("credential-create",function(e){if(e&&e.credential){var t=e.credential.server===r,o=e.credential._oAuthCred&&e.credential._oAuthCred.oAuthInfo===i;t&&o&&n.reloadPortal()}}),n.openApp()):l.getCredential(o)})},e.prototype.fix=function(){var e={before:function(e){var t=!1;!t&&e&&e.requestOptions&&e.requestOptions.query&&e.requestOptions.query.maxAllowableOffset&&(t=!(e.requestOptions.query.maxAllowableOffset=0)),!t&&e&&"string"==typeof e.url&&-1!==e.url.toLowerCase().indexOf("maxAllowableOffset")&&e.requestOptions&&e.requestOptions.query&&(console.warn("esriRequest:resetting maxAllowableOffset",e),t=!(e.requestOptions.query.maxAllowableOffset=0))}},t=u.request;Array.isArray(t.interceptors)?t.interceptors.push(e):t.interceptors=[e]},e.prototype.openApp=function(e){var o=this,n=a.default.getInstance(),t=n.config.portalUrl;u.portalUrl=t;var r=new d;e&&(r.authMode="immediate"),r.load().then(function(e){n.portal=r,n.user.setPortal(r)}).then(function(e){return o.checkLicense(n,r)}).then(function(e){return n.load()}).then(function(e){return n.views=new c.default,n.views.load()}).then(function(e){return n.aiim.load()}).then(function(e){var t=new s.default({container:"layout-container"});n.layout=t,i.default.publish(i.default.AppStarted,{})}).catch(function(e){try{if("__noIndoorsSubscription__"===e)o.showMessage(n.i18n.messages.noIndoorsSubscription);else{console.error("Startup error:",e);var t="Unable to start ArcGIS Indoors";e&&e.message&&(t+=": "+e.message),o.showMessage(t)}}catch(e){console.error("Startup error2:",e)}})},e.prototype.reloadPortal=function(){var t=a.default.getInstance(),o=new d;o.authMode="immediate",o.load().then(function(e){console.log("loadPortal.result:",e),t.portal=o,t.user.setPortal(o),i.default.publish(i.default.SignedIn,{})}).catch(function(e){console.log("Error loading portal:"),console.error(e)})},e.prototype.showMessage=function(t){try{var e=document.createElement("div");e.style.padding="20px",e.innerHTML=t,document.body.appendChild(e)}catch(e){console.error("Startup: error showing message:",t,e)}},e.prototype.startupApp=function(){this.fix(),this.checkBrowser(),this._ok&&this.checkSignIn()},e}();t.default=g,i.default.subscribe(i.default.AppStarted,function(e){}),i.default.subscribe(i.default.SignInClicked,function(){var e=a.default.getInstance().getSharingUrl();l.getCredential(e,{oAuthPopupConfirmation:!1}).then(function(e){}).catch(function(e){console.log("Signin failed"),console.error(e)})}),i.default.subscribe(i.default.SignOutClicked,function(){l.destroyCredentials(),window.location.reload()}),(new g).startupApp()});