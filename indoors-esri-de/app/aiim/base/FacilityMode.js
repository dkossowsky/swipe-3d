var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(e,t){function i(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}();define(["require","exports","../../util/BaseClass","../../context/Context","../datasets/FieldNames","../../context/Topic","../util/aiimUtil","../util/selectionUtil","dojo/dom-style"],function(e,t,i,f,y,c,v,o,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=function(t){function e(e){var l=t.call(this,e)||this;return l._use2DShells=!0,l._use2DShellTransparency=!1,l._zeroVOLevelsByFacilityId={},c.default.subscribe(c.default.AppStarted,function(e){var t=f.default.getInstance();t.config.setLevelOnStart&&(f.default.getInstance().aiim.datasets.facilities&&o.reset2D(t.views.mapView));l._watch2D(),l._watch3D();var i=l._getFacilitiesSource(),a=f.default.getInstance().views.mapView;a&&i&&l._toggleLayerVisibilities2D(a,i,!1)}),c.default.subscribe(c.default.DeactivateFacilityClicked,function(e){try{if(f.default.getInstance().aiim.datasets.facilities){var t=e.facilityInfo&&e.facilityInfo.lastCamera,i=e.facilityInfo&&e.facilityInfo.lastExtent2D;l.activeFacilityInfo=null,o.resetAll(e.view),l._toggleShell(e.view,t,i),c.default.publish(c.default.FacilityDeactivated,{view:e.view}),c.default.publish(c.default.FacilityModeUpdated,{facilityMode:l,view:e.view})}}catch(e){console.error("ViewMode::Topic.DeactivateFacilityClicked",e)}}),c.default.subscribe(c.default.ItemOpened,function(e){e&&e.feature&&e.source&&l._handleItemOpened(e)}),c.default.subscribe(c.default.LevelSelected,function(e){try{if(l.activeFacilityInfo&&l.activeFacilityInfo.facilityId===e.facilityId){var t=e.levelData,i={facilityId:e.facilityId,levelNumber:t&&t.levelNumber};l.activeFacilityInfo.activeLevel=t,o.selectFacility(e.view,i),c.default.publish(c.default.FacilityModeUpdated,{facilityMode:l,view:e.view})}}catch(e){console.error("ViewMode::Topic.LevelSelected",e)}}),c.default.subscribe(c.default.ViewActivated,function(e){l._setViewCursor(!1)}),l}return __extends(e,t),e.prototype._activateFacility=function(a,l,r,n){var s=this;a.facilityId=l,f.default.getInstance().aiim.datasets.levels.getFacilityLevels(l).then(function(e){if(a.levels=e,"number"==typeof r&&e&&0<e.length){var t=r;e.some(function(e){return e.levelNumber===t&&(r=e,!0)})}e&&0<e.length&&(s._zeroVOLevelsByFacilityId[l]?a.zeroVOLevel=s._zeroVOLevelsByFacilityId[l]:e.some(function(e){return 0===e.verticalOrder&&("number"==typeof e.levelNumber&&(s._zeroVOLevelsByFacilityId[l]=e,a.zeroVOLevel=e),!0)}));var i={facilityId:l,levelNumber:r&&r.levelNumber};s.activeFacilityInfo=a,"number"==typeof i.levelNumber?(a.activeLevel=r,o.selectFacility(n,i)):n&&"2d"===n.type&&a.zeroVOLevel?(i.levelNumber=a.zeroVOLevel.levelNumber,o.selectFacility(n,i)):o.resetAll(n),s._toggleShell(n),c.default.publish(c.default.FacilityActivated,{facilityInfo:a,view:n}),c.default.publish(c.default.FacilityModeUpdated,{facilityMode:s,view:n})}).catch(function(e){console.error("Error getting facility levels",a,e)})},e.prototype.activateLevelFilter=function(e,t,i){try{var a=e&&e.camera?e.camera.clone():null,l=e&&"2d"===e.type&&e.extent?e.extent.clone():null;this.activeFacilityInfo&&this.activeFacilityInfo.lastCamera&&(a=this.activeFacilityInfo.lastCamera),this.activeFacilityInfo&&this.activeFacilityInfo.lastExtent2D&&(l=this.activeFacilityInfo.lastExtent2D);var r={facilityId:null,facilityName:null,facilitiesSource:this._getFacilitiesSource(),levels:null,activeLevel:null,zeroVOLevel:null,lastCamera:a,lastExtent2D:l};"string"==typeof t&&0<t.length&&this._activateFacility(r,t,i,e)}catch(e){console.error("ViewMode::activateLevelFilter",e)}},e.prototype.applyActiveFacilityInfo=function(e){var t=this.activeFacilityInfo;if(t){var i=t.facilityId,a=t.activeLevel;this._activateFacility(t,i,a,e)}else{if(!f.default.getInstance().aiim.datasets.facilities)return;o.resetAll(e),this._toggleShell(e,null,null)}},e.prototype._getFacilitiesSource=function(){return f.default.getInstance().aiim.datasets.categories.findSourceByKey("Facilities")},e.prototype._handleItemOpened=function(e){try{var t={facilityId:null,facilityName:null,facilitiesSource:this._getFacilitiesSource(),levels:null,activeLevel:null,zeroVOLevel:null,lastCamera:e.lastCamera,lastExtent2D:e.lastExtent2D};this.activeFacilityInfo&&this.activeFacilityInfo.lastCamera&&(t.lastCamera=this.activeFacilityInfo.lastCamera),this.activeFacilityInfo&&this.activeFacilityInfo.lastExtent2D&&(t.lastExtent2D=this.activeFacilityInfo.lastExtent2D);var i=f.default.getInstance(),a=e.source,l=e.feature,r=i.aiim.datasets.facilities,n=i.aiim.datasets.levels;if(r&&n&&a&&l&&l.geometry){var s=l.attributes,c=void 0;if(a.isAiimFacilities())"string"==typeof(c=v.getAttributeValue(s,y.default.FACILITY_ID))&&0<c.length&&this._activateFacility(t,c,null,e.view);else{c=v.getAttributeValue(l.attributes,y.default.FACILITY_ID);var o=v.getAttributeValue(l.attributes,y.default.LEVEL_NUMBER);"string"==typeof c&&0<c.length&&this._activateFacility(t,c,o,e.view)}}}catch(e){console.error("ViewMode::handleItemOpened",e)}},e.prototype._isActiveFacilityId=function(e,t){return!(!this.activeFacilityInfo||this.activeFacilityInfo.facilityId!==t)},e.prototype._makeTestLevels=function(e,t){if("ESRI.RED.MAIN.O"===e){if(this._tmpTestLevels)return this._tmpTestLevels;for(var i=0,a=[],l=1;l<=10;l++)for(var r=1;r<=3;r++){var n={levelNumber:r,levelShortName:"Level "+ ++i,verticalOrder:r-1};a.push(n)}return this._tmpTestLevels=a}return t},e.prototype.setFromHome=function(e,t,i){var a={content:null,source:e.getSource(),feature:t,lastCamera:null,lastExtent2D:null,view:i};a.feature&&a.source&&this._handleItemOpened(a)},e.prototype._setViewCursor=function(e){var t=e?"pointer":"default";a.set("view-container",{cursor:t})},e.prototype._toggleLayerVisibilities2D=function(e,t,i){},e.prototype._toggleShell=function(e,t,i){var a=function(l,e){o.perLayer([e],function(e,t){var i=v.findField(t,y.default.FACILITY_ID);if(i){var a=i.name+" <> '"+l+"'";e.definitionExpression=a}})},l=this._use2DShells,r=this._getFacilitiesSource(),n=f.default.getInstance().aiim.facilityFootprints;if(this.activeFacilityInfo){var s=this.activeFacilityInfo.facilityId;if(e&&"2d"===e.type&&l&&r&&r.layer2D&&n.activating(this.activeFacilityInfo,r),e&&"2d"===e.type&&l&&r&&r.layer2D)(c=r.layer2D).xtnSubLayer?a(s,c.xtnSubLayer):a(s,c),this._toggleLayerVisibilities2D(e,r,!0);if(e&&"3d"===e.type&&r&&r.layer3D)(c=r.layer3D).renderer&&(c.renderer=null),a(s,c)}else{var c;if(e&&"2d"===e.type&&l&&r&&r.layer2D&&(this._toggleLayerVisibilities2D(e,r.layer2D,!1),n.deactivating(r)),e&&"2d"===e.type&&l&&r&&r.layer2D)(c=r.layer2D).xtnSubLayer?c.xtnSubLayer.definitionExpression&&(c.xtnSubLayer.definitionExpression=null):c.definitionExpression&&(c.definitionExpression=null),i&&e.goTo(i,{duration:1e3,easing:"out-back"});if(e&&"3d"===e.type&&r&&r.layer3D)(c=r.layer3D).renderer&&(c.renderer=null),c.definitionExpression&&(c.definitionExpression=null),t&&e.goTo(t,{duration:1e3,easing:"out-back"})}},e.prototype._watch2D=function(){var n=this,e=f.default.getInstance(),s=e.views.mapView,c=e.aiim.datasets.facilities,o=this._getFacilitiesSource();if(s&&o){var u=e.aiim.facilityFootprints;s&&u&&this._use2DShells&&(s.on("pointer-move",function(e){s.hitTest(e).then(function(e){var t;if(o&&o.layer2D&&o.layer2D,e&&e.results&&0<e.results.length){var i=e.results[0].graphic;if(i&&i.layer&&i.layer===u.layer&&e&&e.results&&1<e.results.length){var a=e.results[1].graphic;a&&a.layer&&a.layer.xtnAboveFacilities&&(i=a)}if(i&&i.layer&&i.layer===u.layer){var l=c.isVisibleAtScale2D(s);if(l){var r=f.default.getInstance().aiim.facilityMode.activeFacilityInfo;if(r)v.getAttributeValue(i.attributes,y.default.FACILITY_ID)===r.facilityId&&(l=!1)}l&&((t=i).xtnHighlighted||(u.highlight(i),n._setViewCursor(!0)))}}t||(n._setViewCursor(!1),u.removeHighlight())})}),s.on("pointer-leave",function(e){n._setViewCursor(!1),u.removeHighlight()}),s.on("click",function(e){n._setViewCursor(!1)}))}},e.prototype._watch3D=function(){var c=this,e=f.default.getInstance(),t=f.default.getInstance().views.sceneView,o=(e.aiim.datasets.facilities,this._getFacilitiesSource());if(t&&o){t.on("pointer-move",function(e){t.hitTest(e).then(function(e){var t,i,a;if(o&&o.layer3D&&(i=o.layer3D),e&&e.results&&0<e.results.length){var l=e.results[0].graphic;l&&l.layer&&l.layer===i&&(t=l)}if(t){var r=t.layer.objectIdField,n=t.attributes[r],s=(a=n,{type:"unique-value",field:r,uniqueValueInfos:[{value:a=parseInt(a,10)||0,label:"Facility Highlight",symbol:{type:"mesh-3d",symbolLayers:[{type:"fill",material:{color:[230,230,230,.6],colorMixMode:"replace"}}]}}]});t.layer.renderer=s,c._setViewCursor(!0)}else i&&i.renderer&&(i.renderer=null),c._setViewCursor(!1)})}),t.on("pointer-leave",function(e){if(o&&o.layer3D){var t=o.layer3D;t&&t.renderer&&(t.renderer=null)}c._setViewCursor(!1)}),t.on("click",function(e){c._setViewCursor(!1)})}},e}(i.default);t.default=l});