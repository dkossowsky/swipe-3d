var __extends=this&&this.__extends||function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,i,r){var l,o=arguments.length,s=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;0<=a;a--)(l=e[a])&&(s=(o<3?l(s):3<o?l(t,i,s):l(t,i))||s);return 3<o&&s&&Object.defineProperty(t,i,s),s};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","esri/core/tsSupport/assignHelper","../../context/Context","../datasets/FieldNames","../util/aiimUtil","esri/core/Accessor","esri/core/accessorSupport/decorators","esri/widgets/Search/support/geometryUtils","esri/core/promiseUtils"],function(e,t,r,l,i,o,a,p,s,n,u,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d=function(i){function e(e){var t=i.call(this,e)||this;return t.sortMethod="closest",t.subTitleField=a.default.NAME_SUBTITLE,t.uniqueIdField=a.default.POINT_OF_INTEREST_ID,t}return r(e,i),e.prototype.checkFieldNameProperty=function(e,t,i){var r,l=this.get(e),o=!1;"string"==typeof l&&0<l.length&&t&&("string"==typeof(r=p.findFieldName(t,l))&&0<r.length&&(l!==r&&this.set(e,r),o=!0),o||console.warn(this.key+" - invalid "+e+": "+l));!o&&i&&("string"==typeof(r=p.findFieldName(t,i))&&0<r.length&&(this.set(e,r),o=!0,console.warn(this.key+" - setting "+e+": "+r)));return o},e.prototype.checkSchema=function(){var d=this;return y.create(function(o,e){if(d.layer2D){var s=d.layer2D;s.when(function(){var e,i,r=s.fields;if(d.displayField||(d.displayField=s.displayField),d.isAiimPeople()&&"string"==typeof d.displayField&&"level_name"===d.displayField.toLowerCase()&&(d.displayField="knownas",console.warn(d.key+" - setting displayField from level_name to knownas")),d.checkFieldNameProperty("displayField",r,a.default.NAME)||(d.displayField=s.objectIdField,console.warn(d.key+" - setting displayField: "+d.displayField)),d.checkFieldNameProperty("uniqueIdField",r,null)||(d.uniqueIdField=s.objectIdField,console.warn(d.key+" - setting uniqueIdField: "+d.uniqueIdField)),d.checkFieldNameProperty("subCategoryField",r,null)||d.isAiimEvents()&&"string"==typeof d.subCategoryField&&"category_subtype"===d.subCategoryField.toLowerCase()&&(d.subCategoryField=null,console.warn(d.key+" - setting subCategoryField from category_subtype to null")),d.checkFieldNameProperty("subTitleField",r,null)||d.isAiimPeople()&&"string"==typeof d.subTitleField&&"name_subtitle"===d.subTitleField.toLowerCase()&&(d.subTitleField="unit_name",d.checkFieldNameProperty("subTitleField",r,null),console.warn(d.key+" - setting subTitleField from name_subtitle to "+d.subTitleField)),"string"==typeof d.searchFields&&0===d.searchFields.indexOf("["))try{var t=JSON.parse(d.searchFields);d.searchFields=t}catch(e){console.warn("Error parsing search fields for",d.name,", searchFields=",d.searchFields),console.error(e)}if(Array.isArray(d.searchFields)&&0<d.searchFields.length){var l=[];d.searchFields.forEach(function(e){if("string"==typeof(i=p.findFieldName(r,e))&&0<i.length){var t=i.toLowerCase();"date_start"===t||"date_end"===t?console.warn(d.key+" - unsupported searchField: "+e):l.push(i)}else console.warn(d.key+" - invalid searchField: "+e)}),d.searchFields=l}Array.isArray(d.searchFields)?0===d.searchFields.length&&(d.searchFields=null):"string"==typeof d.searchFields&&(d.searchFields=null,"string"==typeof(i=p.findFieldName(r,d.searchFields))&&0<i.length?d.searchFields=[i]:(console.warn(d.key+" - invalid searchField: "+d.searchFields),d.searchFields=null)),"string"==typeof(e=function(e){if("string"==typeof e&&2<e.length){var t=e;if(0===t.indexOf('"')&&(t=e.substring(1)).indexOf('"')===t.length-1)return t=t.substring(0,t.length-1)}return e}(e=d.suggestionTemplate))&&0<e.length?function(e,t){var i,r,l,o,s="",a="",n=[],u=!1;for(r=0;r<t.length;r++)i=t.charAt(r),u?"}"===i?(u=!1,s+=o="__"+n.length+"__",n.push(a)):a+=i:"{"===i?(u=!0,a=""):s+=i;for(r=0;r<n.length;r++)o="__"+r+"__",a=n[r],"string"==typeof(l=p.findFieldName(e.fields,a))&&0<l.length?s=s.replace(o,"{"+l+"}"):(s=s.replace(o,""),console.warn(d.key+" - invalid suggestionTemplate field: "+a));0<(s=s.trim()).length?d.suggestionTemplate=s:d.suggestionTemplate=null}(s,e):d.suggestionTemplate=null,o()})}else o()})},e.prototype.findSubType=function(e){var t=null;if(e&&e.attributes&&this.subCategoryField&&this.subCategories){var i=p.getAttributeValue(e.attributes,this.subCategoryField);void 0!==i&&null!=i&&this.subCategories.some(function(e){if(i===e.value)return t=e,!0})}return t},e.prototype.getAiimAddressInfo=function(e){var t={unitId:null,unitName:null,sectionId:null,sectionName:null,levelId:null,levelName:null,levelShortName:null,levelNumber:null,verticalOrder:null,facilityId:null,facilityName:null,siteId:null,siteName:null};if(e&&e.attributes){var i=e.attributes;if(this.isAiimUnits()?(t.unitId=p.getAttributeValue(i,a.default.UNIT_ID),t.unitName=p.getAttributeValue(i,a.default.NAME)):(t.unitId=p.getAttributeValue(i,a.default.UNIT_ID),t.unitName=p.getAttributeValue(i,a.default.UNIT_NAME)),this.isAiimSections()?(t.sectionId=p.getAttributeValue(i,a.default.SECTION_ID),t.sectionName=p.getAttributeValue(i,a.default.NAME)):(t.sectionId=p.getAttributeValue(i,a.default.SECTION_ID),t.sectionName=p.getAttributeValue(i,a.default.SECTION_NAME)),this.isAiimFacilities()?(t.facilityId=p.getAttributeValue(i,a.default.FACILITY_ID),t.facilityName=p.getAttributeValue(i,a.default.NAME)):(t.facilityId=p.getAttributeValue(i,a.default.FACILITY_ID),t.facilityName=p.getAttributeValue(i,a.default.FACILITY_NAME)),this.isAiimSites()?(t.siteId=p.getAttributeValue(i,a.default.SITE_ID),t.siteName=p.getAttributeValue(i,a.default.NAME)):(t.siteId=p.getAttributeValue(i,a.default.SITE_ID),t.siteName=p.getAttributeValue(i,a.default.SITE_NAME)),t.levelNumber=p.getAttributeValue(i,a.default.LEVEL_NUMBER),t.verticalOrder=p.getAttributeValue(i,a.default.VERTICAL_ORDER),this.isAiimLevels())t.levelId=p.getAttributeValue(i,a.default.LEVEL_ID),t.levelName=p.getAttributeValue(i,a.default.NAME),t.levelShortName=p.getAttributeValue(i,a.default.NAME_SHORT);else{t.levelId=p.getAttributeValue(i,a.default.LEVEL_ID),t.levelName=p.getAttributeValue(i,a.default.LEVEL_NAME),"number"==typeof t.levelNumber&&(t.levelShortName=""+t.levelNumber);var r=o.default.getInstance().aiim.datasets.levels;r&&(t.levelShortName=r.getShortNameIfLoaded(t.facilityId,t.levelNumber))}}return t},e.prototype.getFields=function(){if(this.layer2D)return this.layer2D.fields},e.prototype.getObjectIdField=function(){return this.layer2D?this.layer2D.objectIdField:"objectid"},e.prototype.getSubTitle=function(e){if(!e)return null;if(this.subTitleField){var t=e.attributes[this.subTitleField];return"number"==typeof t&&(t=""+t),t}},e.prototype.getTitle=function(e){if(!e)return null;if(this.displayField){var t=e.attributes[this.displayField];return"number"==typeof t&&(t=""+t),t}},e.prototype.isAiimEvents=function(){return this.key&&"events"===this.key.toLowerCase()},e.prototype.isAiimFacilities=function(){return this.key&&"facilities"===this.key.toLowerCase()},e.prototype.isAiimLevels=function(){return this.key&&"levels"===this.key.toLowerCase()},e.prototype.isAiimPeople=function(){return this.key&&"people"===this.key.toLowerCase()},e.prototype.isAiimSections=function(){return this.key&&"sections"===this.key.toLowerCase()},e.prototype.isAiimSites=function(){return this.key&&"sites"===this.key.toLowerCase()},e.prototype.isAiimUnits=function(){return this.key&&"units"===this.key.toLowerCase()},e.prototype.makeCaption=function(e){return this.getTitle(e)},e.prototype.makeSearchResult=function(e,t){var i=this.makeCaption(t),r=null;if(e){var l=e.scale,o=u.createExtentFromGeometry(t.geometry,e,l);r=o}return{extent:r,feature:t,name:i,key:t.attributes[this.uniqueIdField],sourceIndex:this.index}},l([n.property()],e.prototype,"displayField",void 0),l([n.property()],e.prototype,"displayTemplate",void 0),l([n.property()],e.prototype,"icon",void 0),l([n.property()],e.prototype,"iconUrl",void 0),l([n.property()],e.prototype,"index",void 0),l([n.property()],e.prototype,"key",void 0),l([n.property()],e.prototype,"layer2D",void 0),l([n.property()],e.prototype,"layer3D",void 0),l([n.property()],e.prototype,"sortMethod",void 0),l([n.property()],e.prototype,"subCategories",void 0),l([n.property()],e.prototype,"subLayer",void 0),l([n.property()],e.prototype,"subTitleField",void 0),l([n.property()],e.prototype,"subTypesPromise",void 0),l([n.property()],e.prototype,"uniqueIdField",void 0),l([n.property()],e.prototype,"url",void 0),l([n.property()],e.prototype,"categoryLevel",void 0),l([n.property()],e.prototype,"name",void 0),l([n.property()],e.prototype,"searchFields",void 0),l([n.property()],e.prototype,"subCategoryField",void 0),l([n.property()],e.prototype,"suggestionTemplate",void 0),e=l([n.subclass("app.aiim.base.Source")],e)}(n.declared(s));t.default=d});