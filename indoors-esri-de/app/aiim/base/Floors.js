var __extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,i){var s,n=arguments.length,o=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,i);else for(var l=e.length-1;0<=l;l--)(s=e[l])&&(o=(n<3?s(o):3<n?s(t,r,o):s(t,r))||o);return 3<n&&o&&Object.defineProperty(t,r,o),o};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","esri/core/tsSupport/assignHelper","../../context/Context","../../context/Topic","../datasets/FieldNames","../util/aiimUtil","esri/core/Accessor","esri/core/promiseUtils","esri/core/accessorSupport/decorators"],function(e,t,i,s,r,f,n,y,h,o,l,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=function(r){function e(e){var t=r.call(this,e)||this;return t.forRoute=!1,t._is2D=!1,t}return i(e,r),e.prototype.collectStats=function(e,t,r){var i=e.attributes,s=this._stats,n=h.getAttributeValue(i,y.default.SITE_ID),o=h.getAttributeValue(i,y.default.FACILITY_ID),l=h.getAttributeValue(i,y.default.LEVELNUMBER),a="site-"+n,u="facility-"+o,f=s.sites;f||(f=s.sites={});var c=f[a];c||(c=f[a]={id:n,facilities:{}});var p=c.facilities[u];p||(p=c.facilities[u]={id:o,levels2D:[],levels3D:[]});var d=p.levels2D,v=p.levels3D;d[r.index]=l,-1===v.indexOf(l)&&v.push(l)},e.prototype.createStats=function(e,i){var s=this,t=f.default.getInstance().aiim.datasets;if(t.isPeopleLayer(e.layer,this.getFields(e)))return t.units.queryPersonUnit(e,t.people).then(function(e){if(e&&e.fields&&e.features&&0<e.features.length){var t=e.features[0],r=e.fields;s.collectStats(t,r,i)}return i});var r=this.getFields(e);return r&&this.collectStats(e,r,i),l.resolve(i)},e.prototype.createWhereFromStats=function(e,s,n){var o=this,l=(f.default.getInstance().aiim.datasets.categories.findSourceByLayer(e),""),a=function(e,t,r){if(s&&!h.findField(s,t))return e;var i;if(null!=r){if("string"==typeof r){if(0===r.length)return;i=t+" = '"+(r=r.replace("'","''"))+"'"}else i=t+" = "+r;0<e.length&&(e+=" AND "),e+=i}return e},u=function(e,t,r){var i="";i=a(i,y.default.SITE_ID,e.id),i=a(i,y.default.FACILITY_ID,t.id),0<(i=a(i,y.default.LEVELNUMBER,r)).length&&(0<l.length&&(l+=" OR "),l+="("+i+")")};if(this._stats.sites&&Object.keys(this._stats.sites).forEach(function(e){var i=o._stats.sites[e];i&&i.facilities&&Object.keys(i.facilities).forEach(function(e){var t=i.facilities[e];if(t&&t.levels2D&&0<t.levels2D.length){var r=t.levels2D[t.levels2D.length-1];n&&null!=r&&-1===o._levels2D.indexOf(r)&&o._levels2D.push(r),o._is2D&&u(i,t,r)}t&&t.levels3D&&0<t.levels3D.length&&t.levels3D.forEach(function(e){n&&null!=e&&-1===o._levels3D.indexOf(e)&&o._levels3D.push(e),o._is2D||u(i,t,e)})})}),0<l.length){var t=!1,r=y.default.LOCATION_TYPE;if(s){var i=h.findField(s,r);i&&"integer"===i.type?(r=i.name,t=!0):t=!1}t&&(l="("+l+") OR ("+r+" = 0)")}return l},e.prototype.findField=function(e,t){var r=null;if(e){var i=t.toLowerCase();e.some(function(e){if(e.name.toLowerCase()===i)return r=e,!0})}return r},e.prototype.findLevelNumberField=function(e){var t=this.getFields(e);return t?this.findField(t,y.default.LEVELNUMBER):null},e.prototype.hasLevels=function(){return!!f.default.getInstance().aiim.datasets.levels},e.prototype.getFields=function(e){if(e){if(e.fields)return e.fields;if(e.layer&&e.layer.fields)return e.layer.fields;if(e.xtnFields)return e.xtnFields}return null},e.prototype.getLayers=function(e){return e.map.layers.flatten(function(e){return e.layers||e.sublayers})},e.prototype.makeClause=function(e,t){return"string"===e.type?e.name+" = '"+t+"'":e.name+" = "+t},e.prototype.queryLevelsByExtent=function(e){var t=f.default.getInstance().aiim.datasets.levels;return t?t.queryLevelsByExtent(e):l.resolve()},e.prototype.resetAll=function(e){},e.prototype.resetLevel=function(e){},e.prototype.setDefaultLevel=function(){},e.prototype.setDefinitionExpression=function(e,t){},e.prototype.setLevel=function(e,t,r,i){},e.prototype.setLevelFromFeature=function(e,t,r){},e.prototype.setLevelFromFeatures=function(e,t,r){},e.prototype.setLevelFromStats=function(e,t,r){},s([a.property()],e.prototype,"forRoute",void 0),e=s([a.subclass("app.aiim.base.Floors")],e)}(a.declared(o));t.default=u});