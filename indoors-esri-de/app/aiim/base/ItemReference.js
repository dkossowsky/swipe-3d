var __extends=this&&this.__extends||function(){var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,o){var u,i=arguments.length,n=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;0<=s;s--)(u=e[s])&&(n=(i<3?u(n):3<i?u(t,r,n):u(t,r))||n);return 3<i&&n&&Object.defineProperty(t,r,n),n};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","esri/core/tsSupport/assignHelper","../../context/Context","../util/aiimUtil","../util/searchUtil","esri/core/Accessor","esri/core/accessorSupport/decorators","esri/core/promiseUtils"],function(e,t,r,o,u,c,i,l,n,s,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p=function(t){function e(e){return t.call(this)||this}return r(e,t),e.prototype.fromFeature=function(e,t){var r=null,o=null,u=!1,i=c.default.getInstance().aiim.datasets.categories.findSourceByKey(e),n=this.getReferenceProperties(i,t.attributes);return n&&(o=n.uniqueIdField,r=n.uniqueId),null==r?console.warn("Unable to set ReferenceFeature from feature",e,t):(u=!0,this.uniqueId=r,this.uniqueIdField=o,this.sourceKey=i.key,this._source=i),u},e.prototype.fromJson=function(n){var s=this;return a.create(function(u,e){var i=c.default.getInstance().aiim.datasets.categories.findSourceByKey(n.sourceKey);if(i&&i.url&&n.uniqueIdField&&void 0!==n.uniqueId&&null!==n.uniqueId){var t=i.url;l.queryFieldValue(i,t,n.uniqueIdField,n.uniqueId).then(function(e){var t=!1;if(e&&e.features&&1===e.features.length){var r=e.features[0],o=i.makeSearchResult(null,r);o.key=n.uniqueId,(t=s.fromSearchResult(i.key,o))&&("string"==typeof n.userLabel&&0<n.userLabel.length&&(s.userLabel=n.userLabel),s._source=i)}u(t)}).catch(function(e){u(null),console.warn("Error restoring reference feature:",n),console.error(e)})}else console.warn("Error restoring reference feature, invalid source",n),u(null)})},e.prototype.fromSearchResult=function(e,t){var r=this.fromFeature(e,t.feature);return r&&(this.name=t.name,this.searchResult=t),r},e.prototype.getFeature=function(){if(this.searchResult)return this.searchResult.feature},e.prototype.getLabel=function(){return"string"==typeof this.userLabel&&0<this.userLabel.length?this.userLabel:this.getTitle()},e.prototype.getReferenceProperties=function(e,t){var r=null,o=null;return e&&(o=e.uniqueIdField,"string"==typeof(r=i.getAttributeValue(t,o))&&0===r.length&&(r=null)),null!=r?{sourceKey:e.key,uniqueIdField:o,uniqueId:r}:(console.warn("getReferenceProperties.notOk",e,t),null)},e.prototype.getSource=function(){if(this._source)return this._source;var e=c.default.getInstance().aiim.datasets;return this._source=e.categories.findSourceByKey(this.sourceKey),this._source},e.prototype.getSubTitle=function(){if(this._source)return this._source.getSubTitle(this.getFeature())},e.prototype.getTitle=function(){if(this._source)return this._source.getTitle(this.getFeature())},e.prototype.isValid=function(){return!(void 0===this.uniqueId||null===this.uniqueId||!this.searchResult)},e.prototype.toJson=function(){var e={sourceKey:this.sourceKey,uniqueIdField:this.uniqueIdField,uniqueId:this.uniqueId};return"string"==typeof this.userLabel&&0<this.userLabel.length&&(e.userLabel=this.userLabel),e},o([s.property()],e.prototype,"name",void 0),o([s.property()],e.prototype,"searchResult",void 0),o([s.property()],e.prototype,"sourceKey",void 0),o([s.property()],e.prototype,"uniqueId",void 0),o([s.property()],e.prototype,"uniqueIdField",void 0),o([s.property()],e.prototype,"userLabel",void 0),e=o([s.subclass("app.aiim.base.ItemReference")],e)}(s.declared(n));t.default=p});