var __extends=this&&this.__extends||function(){var s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,s){var i,n=arguments.length,a=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,s);else for(var o=e.length-1;0<=o;o--)(i=e[o])&&(a=(n<3?i(a):3<n?i(t,r,a):i(t,r))||a);return 3<n&&a&&Object.defineProperty(t,r,a),a};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","esri/core/tsSupport/assignHelper","../../context/Context","../datasets/FieldNames","../../aiim/base/ItemReference","../util/aiimUtil","esri/core/Accessor","esri/core/promiseUtils","esri/core/accessorSupport/decorators","esri/tasks/support/Query","esri/tasks/QueryTask"],function(e,t,s,i,r,h,n,v,_,a,o,u,b,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c=function(r){function e(e){var t=r.call(this,e)||this;return t.verticalOrderField=n.default.VERTICAL_ORDER,t}return s(e,r),e.prototype.query=function(e){var i=this,n=[],t=e.getSource(),r=e.getFeature(),a={verticalOrder:_.getAttributeValue(r.attributes,this.verticalOrderField),subjectSource:t,subjectFeature:r,results:[]};return h.default.getInstance().aiim.datasets.categories.sources.forEach(function(e){if(e.layer2D){var t=e.layer2D;if("feature"===t.type){var r=[];a.results.push({source:e,items:r});var s=i.queryLayer(a,e,t,r);n.push(s)}}}),0===n.length?o.resolve(a.results):o.eachAlways(n).then(function(e){return a.results=a.results.filter(function(e){return 0<e.items.length}),o.resolve(a.results)})},e.prototype.queryLayer=function(e,i,t,n){var r=e.subjectFeature,a=t.objectIdField,o=r.attributes[a],s=e.verticalOrder,u=null,c=t.xtnOriginalDefinitionExpression;if("string"==typeof c&&0<c.length&&"__none__"!==c&&(u=c),"number"==typeof s){var l=_.findField(t.fields,this.verticalOrderField);l&&(c=l.name+" = "+s,u=u?"("+u+") AND ("+c+")":c)}u||(u="1=1");var f=h.default.checkMixedContent(t.url)+"/"+t.layerId,p=new m({url:f}),d=new b;d.outFields=["*"];var y=h.default.getInstance().views.mapView;return y&&(d.outSpatialReference=y.spatialReference),d.returnGeometry=!0,d.returnZ=!0,d.multipatchOption="xyFootprint",d.where=u,d.orderByFields=[i.displayField],r.geometry.type,d.geometry=r.geometry,d.spatialRelationship="intersects",p.execute(d).then(function(e){e&&e.features&&0<e.features.length&&e.features.forEach(function(e){if(o!==e.attributes[a]){var t=i.makeSearchResult(null,e),r=new v.default;r.fromSearchResult(i.key,t),n.push(r);var s=i.findSubType(e);s&&(r.subType=s)}})})},e=i([u.subclass("app.aiim.base.RelatedItems")],e)}(u.declared(a));t.default=c});