var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])};return function(e,t){function s(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}}(),__decorate=this&&this.__decorate||function(e,t,s,a){var r,i=arguments.length,o=i<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,a);else for(var n=e.length-1;0<=n;n--)(r=e[n])&&(o=(i<3?r(o):3<i?r(t,s,o):r(t,s))||o);return 3<i&&o&&Object.defineProperty(t,s,o),o};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","esri/core/tsSupport/assignHelper","../../context/Context","./Categories","./Details","./Events","./Facilities","./IndoorsConfig","./Landmarks","./Levels","./Pathways","./People","./Sections","./Sites","./Transitions","./Units","./Zones","../util/aiimUtil","esri/core/Accessor","esri/core/accessorSupport/decorators","esri/core/promiseUtils"],function(e,t,a,r,s,i,o,n,l,p,c,u,y,d,f,h,v,L,w,D,_,g,S,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var b=function(s){function e(e){var t=s.call(this,e)||this;return t._datasets=[],t}return a(e,s),e.prototype.checkSchemas=function(){var s=[];return this._datasets.forEach(function(e){var t=e.checkSchema();t&&s.push(t)}),0<s.length?m.eachAlways(s).then(function(e){}):m.resolve()},e.prototype.isPeopleLayer=function(e,t){return!!this.people&&this.people.isPeopleLayer(e,t)},e.prototype.load=function(){var e=this,t=i.default.getInstance().views.mapView;return this.waitForMapService(t).then(function(){e.processMapView(t),e.processSceneView(i.default.getInstance().views.sceneView)}).then(function(){return e.loadIndoorsConfig()}).then(function(){return e.checkSchemas()}).then(function(){return e.loadCategories()}).then(function(){})},e.prototype.loadIndoorsConfig=function(){return this.indoorsConfig=new c.default,this.indoorsConfig.load(this._indoorsConfigUrl)},e.prototype.loadCategories=function(){return this.categories=new o.default,this.categories.load(this._categoriesUrl)},e.prototype.processMapView=function(t){var s=this;if(t){var e=_.getLayers(t);e.forEach(function(e){"Details"===e.title?(s.details||(s.details=new n.default),s._datasets.push(s.details),s.setDatasetLayer(s.details,t,e)):"Events"===e.title?(s.events||(s.events=new l.default),s._datasets.push(s.events),s.setDatasetLayer(s.events,t,e)):"Facilities"===e.title?(s.facilities||(s.facilities=new p.default),s._datasets.push(s.facilities),s.setDatasetLayer(s.facilities,t,e)):"Landmarks"===e.title?(s.landmarks||(s.landmarks=new u.default),s._datasets.push(s.landmarks),s.setDatasetLayer(s.landmarks,t,e)):"Levels"===e.title?(s.levels||(s.levels=new y.default),s._datasets.push(s.levels),s.setDatasetLayer(s.levels,t,e)):"Pathways"===e.title?(s.pathways||(s.pathways=new d.default),s._datasets.push(s.pathways),s.setDatasetLayer(s.pathways,t,e)):"People"===e.title?(s.people||(s.people=new f.default),s._datasets.push(s.people),s.setDatasetLayer(s.people,t,e)):"Sections"===e.title?(s.sections||(s.sections=new h.default),s._datasets.push(s.sections),s.setDatasetLayer(s.sections,t,e)):"Sites"===e.title?(s.sites||(s.sites=new v.default),s._datasets.push(s.sites),s.setDatasetLayer(s.sites,t,e)):"Transitions"===e.title?(s.transitions||(s.transitions=new L.default),s._datasets.push(s.transitions),s.setDatasetLayer(s.transitions,t,e)):"Units"===e.title?(s.units||(s.units=new w.default),s._datasets.push(s.units),s.setDatasetLayer(s.units,t,e)):"Zones"===e.title&&(s.zones||(s.zones=new D.default),s._datasets.push(s.zones),s.setDatasetLayer(s.zones,t,e))});var a=t.map.tables;if(a&&0<a.length&&a.forEach(function(e){var t="";"string"==typeof e.title&&(t=e.title.toUpperCase()),"CATEGORIES"===t?s._categoriesUrl=e.url:"INDOORS CONFIGURATION"!==t&&"INDOORSCONFIG"!==t||(s._indoorsConfigUrl=e.url)}),this.facilities){var r=!1,i=!1;e.forEach(function(e){e!==s.facilities.layer2D&&e!==s.facilities.subLayer||(r=!0),i&&(e.xtnAboveFacilities=!0),r&&(i=!0)})}}},e.prototype.processSceneView=function(t){var s=this;t&&_.getLayers(t).forEach(function(e){"Details"===e.title?s.setDatasetLayer(s.details,t,e):"Events"===e.title?s.setDatasetLayer(s.events,t,e):"Facilities"===e.title||"Facilities Textured"===e.title?s.setDatasetLayer(s.facilities,t,e):"Landmarks"===e.title?s.setDatasetLayer(s.landmarks,t,e):"Levels"===e.title?s.setDatasetLayer(s.levels,t,e):"Pathways"===e.title?s.setDatasetLayer(s.pathways,t,e):"People"===e.title?s.setDatasetLayer(s.people,t,e):"Sections"===e.title?s.setDatasetLayer(s.sections,t,e):"Sites"===e.title?s.setDatasetLayer(s.sites,t,e):"Transitions"===e.title?s.setDatasetLayer(s.transitions,t,e):"Units"===e.title||"Units3D"===e.title?s.setDatasetLayer(s.units,t,e):"Zones"===e.title&&s.setDatasetLayer(s.zones,t,e)})},e.prototype.setDatasetLayer=function(e,t,s){if(e){s.url;if(s.xtnAiim={dataset:e},"2d"===t.type)if(s&&"esri.layers.support.Sublayer"===s.declaredClass){var a=s.xtnFeatureLayer;a||(a=s.createFeatureLayer()).load(),e.subLayer=s,e.url=s.url,e.layer2D=a,e.layer2D.xtnAiim=s.xtnAiim}else e.url=s.url+"/"+s.layerId,e.layer2D=s;else"3d"===t.type&&(e.layer3D=s)}},e.prototype.waitForMapService=function(s){var t=[];return s&&"2d"===s.type&&s.map.layers.forEach(function(e){"map-image"===e.type&&"function"==typeof e.when&&t.push(e.when().then())}),0<t.length?m.eachAlways(t).then(function(e){var t=_.getLayers(s);t.forEach(function(e){if(e&&"esri.layers.support.Sublayer"===e.declaredClass&&!e.xtnFeatureLayer){var t=e.createFeatureLayer();t&&((e.xtnFeatureLayer=t).xtnSubLayer=e,t.load())}});try{t.forEach(function(t){if(t&&"esri.layers.support.Sublayer"===t.declaredClass&&t.visible&&t.xtnFeatureLayer){var s=t.xtnFeatureLayer;s.when(function(){if(s.source&&s.source.layerDefinition){var e=s.source.layerDefinition.defaultVisibility;"boolean"==typeof e&&t.visible&&!e&&(t.visible=!1)}})}})}catch(e){console.log("Error restoring defaultVisibility",e)}}):m.resolve()},r([S.property()],e.prototype,"categories",void 0),r([S.property()],e.prototype,"indoorsConfig",void 0),r([S.property()],e.prototype,"details",void 0),r([S.property()],e.prototype,"events",void 0),r([S.property()],e.prototype,"facilities",void 0),r([S.property()],e.prototype,"landmarks",void 0),r([S.property()],e.prototype,"levels",void 0),r([S.property()],e.prototype,"pathways",void 0),r([S.property()],e.prototype,"people",void 0),r([S.property()],e.prototype,"sections",void 0),r([S.property()],e.prototype,"sites",void 0),r([S.property()],e.prototype,"transitions",void 0),r([S.property()],e.prototype,"units",void 0),r([S.property()],e.prototype,"zones",void 0),e=r([S.subclass("app.aiim.datasets.Datasets")],e)}(S.declared(g));t.default=b});