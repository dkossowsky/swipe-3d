var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,n){var o,a=arguments.length,i=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;0<=s;s--)(o=e[s])&&(i=(a<3?o(i):3<a?o(t,r,i):o(t,r))||i);return 3<a&&i&&Object.defineProperty(t,r,i),i};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","esri/core/tsSupport/assignHelper","../../context/Context","./Dataset","../base/Source","../util/aiimUtil","esri/core/accessorSupport/decorators","esri/core/promiseUtils","esri/request","esri/layers/FeatureLayer","esri/tasks/support/Query","esri/tasks/QueryTask"],function(e,t,n,o,r,s,a,l,u,i,c,f,d,p,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var h=function(r){function e(e){var t=r.call(this,e)||this;return t.sources=[],t.type="table",t.catLevelField="category_level",t.layerField="layer",t.nameField="name",t.objectIdField="objectid",t}return n(e,r),e.prototype.checkSchemas=function(){var r=this,n=[];return this.sources.forEach(function(e){var t=e.checkSchema();t&&(n.push(t),t.then(function(){r.querySubCategories(e)}))}),0<n.length?c.eachAlways(n).then(function(e){}):c.resolve()},e.prototype.fill=function(t){var r=this.getFillInfo(t.name);r&&Object.keys(r).forEach(function(e){t[e]=r[e]})},e.prototype.getFillInfo=function(e){var t=s.default.getInstance().config.categories;if(t&&t.fill)return t.fill[e]},e.prototype.findSourceByKey=function(t){var r=null;return this.sources.some(function(e){if(e.key===t)return r=e,!0}),r},e.prototype.findSourceByLayer=function(t){var r=null;return this.sources.some(function(e){if(t&&e.layer2D===t||e.layer3D===t||e.subLayer===t)return r=e,!0}),r},e.prototype.load=function(e){var i=this;return e=this.url=s.default.checkMixedContent(e),this.queryCategories().then(function(){var e,t=!1,r=!1,n=!1,o=!1,a=-1;(i.sources.forEach(function(e){a++,e.index=a,"Events"===e.name&&(t=!0),"Units"===e.name&&(r=!0),"Levels"===e.name&&(n=!0),"Facilities"===e.name&&(o=!0)}),!t&&i.getFillInfo("Events"))&&((e=new l.default({name:"Events"})).key=e.name,i.sources.push(e),i.fill(e));!r&&i.getFillInfo("Units")&&((e=new l.default({name:"Units"})).key=e.name,i.sources.push(e),i.fill(e));!n&&i.getFillInfo("Levels")&&((e=new l.default({name:"Levels"})).key=e.name,i.sources.push(e),i.fill(e));!o&&i.getFillInfo("Facilities")&&((e=new l.default({name:"Facilities"})).key=e.name,i.sources.push(e),i.fill(e));return i.processView(s.default.getInstance().views.mapView),i.processView(s.default.getInstance().views.sceneView),i.checkSchemas()}).catch(function(e){console.warn("Error creating CATEGORIES:"),console.error(e)})},e.prototype.loadIcon=function(e,t){var o=this.url+"/"+e+"/attachments";return f(o,{query:{f:"json"},responseType:"json"}).then(function(e){var t=[];if(e&&e.data&&e.data.attachmentInfos&&e.data.attachmentInfos.forEach(function(e){"string"==typeof e.contentType&&"image"===e.contentType.substr(0,5)&&t.push(e)}),t.sort(function(e,t){return e.name.localeCompare(t.name)}),0<t.length){var r=t[t.length-1],n=o+"/"+r.id;return c.resolve({iconUrl:n})}}).catch(function(e){console.warn("Error querying category icon:",o),console.error(e)})},e.prototype.loadSubTypeIcon=function(n,e){var o=this,t=n.name.replace("'","''"),r=e.name.replace("'","''"),a=this.url,i=new y({url:a}),s=new p;return s.outFields=[this.objectIdField],s.where="("+this.catLevelField+" = 2)",s.where+=" AND ("+this.layerField+" = '"+t+"')",s.where+=" AND ("+this.nameField+" = '"+r+"')",i.execute(s).then(function(e){if(e&&e.features&&0<e.features.length){var t=e.features[0].attributes,r=u.getAttributeValue(t,o.objectIdField);return o.loadIcon(r,n).then(function(e){if(e&&e.iconUrl)return e})}return null})},e.prototype.makeSearchSource=function(e,t){return e?{aiimKey:t.key,featureLayer:e,name:t.name,placeholder:t.name,outFields:t.out_fields||["*"],searchFields:t.searchFields,displayField:t.displayField,suggestionTemplate:t.suggestionTemplate,exactMatch:!1,maxResults:6,maxSuggestions:6,suggestionsEnabled:!0,minSuggestCharacters:0,autoNavigate:!1,popupEnabled:!1,popupOpenOnSelect:!1,resultGraphicEnabled:!1}:null},e.prototype.makeSearchSourceLayer=function(e){if(e.layer2D){var t=e.layer2D.url+"/"+e.layer2D.layerId;return t=s.default.checkMixedContent(t),new d({url:t,outFields:["*"],returnZ:!0})}},e.prototype.makeSearchSources=function(){var n=this,o=[];return this.sources&&this.sources.forEach(function(e){var t=n.makeSearchSourceLayer(e),r=n.makeSearchSource(t,e);r&&o.push(r)}),o},e.prototype.processView=function(r){var n=this;r&&u.getLayers(r).forEach(function(t){n.sources.forEach(function(e){e.name===t.title?n.setSourceLayer(e,r,t):"Facilities"===e.name&&"Facilities Textured"===t.title?n.setSourceLayer(e,r,t):"Units"===e.name&&"Units3D"===t.title&&n.setSourceLayer(e,r,t)})})},e.prototype.queryCategories=function(){var o=this,r=this.url;return"string"!=typeof r||0===r.length?(console.error("Error: Missing CATEGORIES table."),c.resolve()):u.readServiceJson(r).then(function(e){if(e&&e.data&&(e.data.objectIdField&&(o.objectIdField=e.data.objectIdField),e.data.fields)){var t=e.data.fields;o.catLevelField=u.findFieldName(t,o.catLevelField),o.layerField=u.findFieldName(t,o.layerField),o.nameField=u.findFieldName(t,o.nameField)}}).then(function(){var e=new y({url:r}),t=new p;return t.outFields=["*"],t.orderByFields=[o.nameField],t.where=o.catLevelField+" = 1",e.execute(t).then(function(e){e&&e.features&&0<e.features.length?e.features.forEach(function(e){var t=e.attributes,r=new l.default({name:u.getAttributeValue(t,"name"),categoryLevel:u.getAttributeValue(t,"category_level"),subCategoryField:u.getAttributeValue(t,"child_field"),searchFields:u.getAttributeValue(t,"search_fields"),suggestionTemplate:u.getAttributeValue(t,"suggestion_template"),layer2D:null,layer3D:null});if(r.key=r.name,"Events"!==r.name){o.sources.push(r),o.fill(r);var n=u.getAttributeValue(t,o.objectIdField);o.loadIcon(n).then(function(e){e&&e.iconUrl&&(r.iconUrl=e.iconUrl)})}}):console.warn("Warning: The CATEGORIES table is empty.")})}).catch(function(e){console.warn("Error querying CATEGORIES table:"),console.error(e)})},e.prototype.querySubCategories=function(n){var o=this;if(!n.subCategoryField)return c.resolve();if(!n.url)return c.resolve();var a=[],i=n.subCategoryField,e=s.default.checkMixedContent(n.url),t=new y({url:e}),r=new p;r.returnGeometry=!1,r.outFields=[i],r.returnDistinctValues=!0,r.where="1 = 1",r.orderByFields=[i],n.subTypesPromise=t.execute(r),n.subTypesPromise.then(function(e){n.subCategories=[],e&&e.features&&0<e.features.length&&(e.features.forEach(function(e){var t=u.getAttributeValue(e.attributes,i),r={name:t,value:t,iconPromise:null,iconUrl:null,subTypeIcon:null};a.push(r);try{r.iconPromise=o.loadSubTypeIcon(n,r),r.iconPromise.then(function(e){e&&e.iconUrl&&(r.iconUrl=e.iconUrl,r.iconUrl=u.appendTokenToUrl(r.iconUrl))}).catch(function(e){console.warn("Error loading subtype icon:"),console.error(e)})}catch(e){console.warn("Error loading subtype icon:"),console.error(e)}}),n.subCategories=a)}).catch(function(e){console.warn("Error querying category sub-types:"),console.error(e)})},e.prototype.setSourceLayer=function(e,t,r){if(r.xtnAiim||(r.xtnAiim={}),r.xtnAiim.source=e,"2d"===t.type)if(r&&"esri.layers.support.Sublayer"===r.declaredClass){var n=r.xtnFeatureLayer;n||(n=r.createFeatureLayer()).load(),e.subLayer=r,e.url=r.url,e.layer2D=n,e.layer2D.xtnAiim||(e.layer2D.xtnAiim=r.xtnAiim)}else e.url=r.url+"/"+r.layerId,e.layer2D=r;else"3d"===t.type&&(e.layer3D=r)},o([i.property()],e.prototype,"sources",void 0),o([i.property()],e.prototype,"type",void 0),e=o([i.subclass("app.aiim.datasets.Categories")],e)}(i.declared(a.default));t.default=h});