define(["require","exports","../../context/Context","./aiimUtil","./searchUtil","esri/core/promiseUtils","esri/geometry/Extent"],function(e,r,f,y,h,m,b){"use strict";function p(e,r,t,o){if(r&&r.layer&&"map-image"===r.layer.type)return function(y,e,r,h){var p=[],d=r.mapPoint;if(d){var v=f.default.getInstance().aiim.datasets.categories,a=y.get("scale"),t=e.allSublayers.toArray().slice(0).reverse();(t=t.filter(function(e){var r=0===e.minScale||a<=e.minScale,t=0===e.maxScale||a>=e.maxScale;return e.visible&&r&&t})).forEach(function(r){var e,t,a,n,i,u,s=v.findSourceByLayer(r),c=r.popupEnabled;if(c&&!r.popupTemplate&&(c=!1),s||h&&c){var o=r.createQuery(),l=function(e){if(!e)return 6;var r=function(e,r){return r&&r.xoffset?Math.max(e,Math.abs(r.xoffset)):r&&r.yoffset?Math.max(e,Math.abs(r.yoffset)):e};if("simple"===e.type)return r(6,e.symbol);if("unique-value"===e.type){var t=6;return e.uniqueValueInfos.forEach(function(e){t=r(t,e.symbol)}),t}if("class-breaks"===e.type){var a=6;return e.classBreakInfos.forEach(function(e){a=r(a,e.symbol)}),a}return 6}(r.renderer);o.geometry=(t=d,a=l,n=(e=y).get("state.resolution"),i=a*("number"==typeof n?n:1),u=e.spatialReference,new b({xmin:Math.min(t.x-i,t.x+i),ymin:Math.min(t.y-i,t.y+i),xmax:Math.max(t.x-i,t.x+i),ymax:Math.max(t.y-i,t.y+i),spatialReference:u})),o.outFields=["*"];var f=r.queryFeatures(o).then(function(e){return e&&e.features&&0<e.features.length?(!s&&h&&e.features.forEach(function(e){e.layer=r}),{source:s,layer:r,features:e.features,queryResult:e}):null});p.push(f)}})}if(0<p.length){var n=m.create(function(t,e){m.all(p).then(function(e){var r=[];e&&e.forEach(function(e){e&&(e.source||h)&&r.push(e)}),t(r)}).catch(function(e){console.warn("Error hitTest::queryMapService"),console.error(e),t()})});return n}return m.resolve()}(e,r.layer,t,o);if(r&&"function"==typeof r.hitTest){var a=t.screenPoint,n=r.hitTest(a.x,a.y);if(n)return m.create(function(u,e){var s=f.default.getInstance().aiim.datasets.categories,c=f.default.getInstance().aiim.facilityFootprints;n.then(function(e){var r=[];if(Array.isArray(e)&&console.warn("Warning: aiim/util/hitTest::queryLayerView result is an Array....."),e&&e.layer&&e.layer.title){var t=s.findSourceByLayer(e.layer),a=e.layer,n=e.layer.popupEnabled,i=e.layer.id===c.layerId&&e.visible;i&&(t=c.getSource())&&(a=t.layer2D),(t||o&&n&&e.visible)&&r.push({source:t,layer:a,features:[e],hitResult:e,isFacilityFootprint:i})}u(r)}).catch(function(e){console.warn("Error hitTest::queryLayerView"),console.error(e),u()})})}return m.resolve()}function n(e,r,t){if("2d"===e.type){var a=r.screenPoint;return!e._setup||isNaN(a.x)||isNaN(a.y)?m.resolve():(c=r,o=t,l=[],(s=e).allLayerViews.toArray().slice(0).reverse().forEach(function(e){var r=!0;if(e&&e.layer&&e.layer.parent&&"esri.Basemap"===e.layer.parent.declaredClass&&(r=!1),r){var t=p(s,e,c,o);t&&l.push(t)}}),0<l.length?m.create(function(t,e){m.all(l).then(function(e){var r=[];e&&e.forEach(function(e){Array.isArray(e)?e.forEach(function(e){e&&(e.source||o)&&r.push(e)}):e&&(e.source||o)&&r.push(e)}),t(r)}).catch(function(e){console.warn("Error hitTest::queryLayerViews"),console.error(e),t()})}):m.resolve())}return n=e,i=r,u=t,m.create(function(r,e){n.hitTest(i.screenPoint).then(function(e){var a=[];if(e&&e.results&&0<e.results.length){var n=f.default.getInstance().aiim.datasets.categories;e.results.forEach(function(e){if(e&&e.graphic&&e.graphic.layer&&e.graphic.layer.title){var r=n.findSourceByLayer(e.graphic.layer),t=e.graphic.layer.popupEnabled;(r||u&&t)&&a.push({source:r,layer:e.graphic.layer,features:[e.graphic],hitResult:e})}})}r(a)}).catch(function(e){console.warn("Error hitTest::querySceneView"),console.error(e),r()})});var n,i,u,s,c,o,l}Object.defineProperty(r,"__esModule",{value:!0}),r.search=function(l,t,a){var f=[];return m.create(function(e,r){n(l,t,a).then(function(e){if(e&&0<e.length){var r=e[0];if("2d"===l.type&&r.isFacilityFootprint&&1<e.length){var t=e[1];t&&t.layer&&t.layer.xtnAboveFacilities&&(r=t)}var a=function(e,r){var t=r.source,a=r.layer,n=r.features[0],i={source:r.source,sourceKey:t&&t.key,sourceIndex:t&&t.index,featureLayer:null,feature:null,objectId:null,searchResult:null,isNonAiimFeature:!t};if("scene"===a.type){if(a.associatedLayer&&"feature"===a.associatedLayer.type&&a.associatedLayer.objectIdField){var u=a.associatedLayer.objectIdField;i.featureLayer=a.associatedLayer,i.objectId=y.getAttributeValue(n.attributes,u)}}else"esri.layers.support.Sublayer"===a.declaredClass?t&&t.layer2D&&t.layer2D.objectIdField&&(u=t.layer2D.objectIdField,i.featureLayer=t.layer2D,i.objectId=y.getAttributeValue(n.attributes,u)):"feature"===a.type&&a.objectIdField&&(u=a.objectIdField,i.featureLayer=a,i.objectId=y.getAttributeValue(n.attributes,u));return i}(0,r);if(a.isNonAiimFeature)r.features&&0<r.features.length&&(a.feature=r.features[0],a.searchResult={feature:r.features[0]},f.push(a));else if(a.featureLayer)return(n=a,i=l,u=n.source,s=n.featureLayer,c=n.objectId,o=i&&"3d"===i.type,m.create(function(r,t){var e=s.url+"/"+s.layerId;h.queryFieldValue(u,e,null,c,!0).then(function(e){if(e&&1===e.features.length&&("multipatch"===s.geometryType||o)){var r=u.uniqueIdField,t=y.getAttributeValue(e.features[0].attributes,r);if(r&&t)return h.queryFieldValue(u,u.url,r,t)}return e}).then(function(e){if(e&&1===e.features.length){var r=e.features[0];n.feature=r,a=i,(t=n).searchResult=t.source.makeSearchResult(a,t.feature),t.searchResult.key=t.objectId,t.caption=t.searchResult.name}var t,a;return e}).then(function(e){r(e)}).catch(function(e){t(e)})})).then(function(){a.feature&&f.push(a)})}var n,i,u,s,c,o}).then(function(){e(f)}).catch(function(e){r(e)})})}});