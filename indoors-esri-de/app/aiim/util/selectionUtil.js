define(["require","exports","../../context/Context","../datasets/FieldNames","../util/aiimUtil"],function(e,i,t,d,c){"use strict";function x(e,i,n,t,r){var a,f=" = ",s=" AND ";if(t&&(f=" "+t+" "),r&&(s=" "+r+" "),null!=n&&"string"==typeof i&&0<i.length){if("string"==typeof n){if(0===n.length)return;a=i+f+"'"+(n=n.replace("'","''"))+"'"}else a=i+f+n;0<e.length&&(e+=s),e+=a}return e}function p(){var e=t.default.getInstance().config.defaultVerticalOrder;return"number"!=typeof e&&(e=0),e}function g(e,i){var n=t.default.getInstance().aiim.datasets.facilities;if(n)return n.getFacilityIdField(e,i)}function s(e){var i=t.default.getInstance().aiim.datasets.facilities;return i&&e&&e.xtnAiim&&e.xtnAiim.dataset===i}function y(e,i,n,t){var r="";if(c.findField(i,d.default.VERTICAL_ORDER))if(r="1=2",t){e&&e.xtnAiim&&e.xtnAiim.dataset&&e.xtnAiim.dataset.requiresFacilityMode||(r="1=1")}else{var a=c.findField(i,d.default.LOCATION_TYPE);a&&"integer"===a.type&&(r="("+a.name+" = 0)")}return r}function n(e,i){e.forEach(function(e){"esri.layers.support.Sublayer"===e.declaredClass?e.xtnFeatureLayer&&e.xtnFeatureLayer.when(function(){i(e,e.xtnFeatureLayer.fields)}):e.when(function(){i(e,e.fields)})})}function r(e){p();var i=c.getLayers(e),t=!1,r=!1;n(i,function(e,i){!r&&s(e)&&(r=!0);var n=y(e,i,0,t);n&&0<n.length&&o(e,n),r&&(t=!0)})}function o(e,i){e.xtnOriginalDefinitionExpression||(e.definitionExpression?e.xtnOriginalDefinitionExpression=e.definitionExpression:e.xtnOriginalDefinitionExpression="__none__");var n=e.xtnOriginalDefinitionExpression;"__none__"!==n&&"string"==typeof n&&0<n.length&&(i=n+" AND ("+i+")"),e.definitionExpression=i}Object.defineProperty(i,"__esModule",{value:!0}),i.perLayer=n,i.reset2D=r,i.resetAll=function(e){var i;e&&"2d"===e.type?r(e):e&&"3d"===e.type&&(i=e,c.getLayers(i).forEach(function(e){e.definitionExpression&&e.xtnOriginalDefinitionExpression&&("__none__"===e.xtnOriginalDefinitionExpression?e.definitionExpression=null:e.definitionExpression=e.xtnOriginalDefinitionExpression)}))},i.selectFacility=function(e,t){var r=e&&"2d"===e.type,i=c.getLayers(e),a=!1,f=!1;n(i,function(e,i){var n;r?(!f&&s(e)&&(f=!0),n=function(e,i,n,t){var r="",a="",f=n.facilityId,s=n.levelNumber;if("string"==typeof f&&0<f.length){var o=g(e,i),l=c.findField(i,d.default.LEVEL_NUMBER);if(o&&l)if("number"==typeof s){r=x(r=x(r,o.name,f),l.name,s),t&&(e&&e.xtnAiim&&e.xtnAiim.dataset&&e.xtnAiim.dataset.requiresFacilityMode||(r="("+r+") OR ("+(a=x(a,o.name,f,"<>"))+")"));var u=c.findField(i,d.default.LOCATION_TYPE);u&&"integer"===u.type&&(r="("+r+") OR ("+u.name+" = 0)")}else r=y(e,i,p(),t)}return r}(e,i,t,a),f&&(a=!0)):n=function(e,i,n){var t="",r=n.facilityId,a=n.levelNumber;if("string"==typeof r&&0<r.length){var f=g(e,i),s=c.findField(i,d.default.LEVEL_NUMBER);f&&s&&(t="number"==typeof a?x(t="("+(t=x(t=x(t,f.name,r),s.name,a))+")",f.name,r,"<>","OR"):"1=1")}return t}(e,i,t),n&&0<n.length&&o(e,n)})}});