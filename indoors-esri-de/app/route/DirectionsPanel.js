var __extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,i){var o,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;0<=a;a--)(o=e[a])&&(n=(s<3?o(n):3<s?o(t,r,n):o(t,r))||n);return 3<s&&n&&Object.defineProperty(t,r,n),n};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","../context/Context","../context/Topic","./core/Directions","./Print","./Util","../utils/mapUtils","esri/core/accessorSupport/decorators","esri/widgets/support/widget","esri/widgets/Widget","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol","esri/symbols/PictureMarkerSymbol"],function(e,t,i,o,f,s,v,n,a,g,c,l,r,w,y,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u="i-directions",d="i-directions-header-bar",h="btn",p="btn",S="i-padded",b=function(r){function e(e){var i=r.call(this)||this;i.hasPrintTask=!1,i.hasServiceUrl=!1,i.hasSources=!1,i.util=new a.default,i.watchHandles=[];var t=new n.default;return i.hasPrintTask=!!t.getPrintTaskUrl(),i.own(s.default.subscribe(s.default.FacilityModeUpdated,function(e){if(i.directions&&i.directions.viewModel){var t=i.directions.viewModel,r=t.get("_routeLayer");t.view&&t.indoorsRouteResult&&r&&t.indoorsRouteResult.afterSetLevel(t.view,r.graphics)}})),i.own(s.default.subscribe(s.default.DirectionsClicked,function(e){try{e&&e.searchResult&&i.setupTarget(e.searchResult)}catch(e){console.warn("Error DirectionsPanel::setupTarget"),console.error(e)}})),i.own(s.default.subscribe(s.default.ViewActivated,function(e){if(i.directions&&i.directions.view!==e.view){var t=i.directions.viewModel,r=t.get("_routeLayer");e.view&&t.indoorsRouteResult&&r&&t.indoorsRouteResult.addRouteGraphics(e.view,r.graphics),i.directions.view=e.view}})),i}return i(e,r),e.prototype.check=function(){var e=f.default.getInstance();!this.directions&&e.views&&e.views.activeView&&this.makeDirectionsWidget()},e.prototype.clearWatchHandles=function(){this.watchHandles.forEach(function(e){try{e.remove()}catch(e){console.error(e)}}),this.watchHandles=[]},e.prototype.makeDirectionsWidget=function(){var n=this,a=f.default.getInstance(),e=a.views.activeView,t=a.config.networkServiceUrl;if(t&&0!==t.length){if("string"==typeof t&&0<t.length){var r=t.lastIndexOf("/Route");-1!==r&&r===t.length-6||(t+="/Route"),this.hasServiceUrl=!0}else this.hasServiceUrl=!1;var c=a.aiim.datasets.categories.makeSearchSources();if(c&&0<c.length?this.hasSources=!0:this.hasSources=!1,this.hasServiceUrl&&this.hasSources){this.directions=new v.default({view:e,routeServiceUrl:t,searchProperties:{allPlaceholder:a.i18n.directions.allPlaceholder,sources:c,includeDefaultSources:!1,locationEnabled:!1}});var l=this.directions.viewModel;l.indoorsDirectionsPanel=this,l.routeParameters.directionsLengthUnits=this.util.getLocaleDistanceUnits(),l.routeParameters.outSpatialReference=e.spatialReference.clone(),l.routeParameters.directionsStyleName="NA Campus",l.routeParameters.outputLines="true-shape-with-measure",l.routeParameters.returnDirections=!0,l.routeParameters.returnRoutes=!0,l.routeParameters.returnZ=!0,l.routeParameters.directionsOutputType="esriDOTFeatureSets";var i=a.config.graphicElevationOffset,o=function(e,t,r){e&&!e.elevationInfo&&(e.elevationInfo={mode:"relative-to-ground",offset:i,unit:"meters"},(t||r)&&(e.elevationInfo.offset=i+.05))},s=(l.get("routeSymbol"),l.get("stopSymbols"));l.indoorsRouteSymbolFor3D=new w({color:[0,94,149,1],width:7,cap:"round",join:"round"}),l.indoorsRouteSymbol=new w({color:[0,94,149,1],width:7,cap:"square",join:"round"}),l.indoorsRouteSymbolAlternate=new w({color:[0,94,149,1],width:4,cap:"square",join:"round",style:"short-dash"}),l.indoorsRouteSymbolTransition=l.indoorsRouteSymbolAlternate,l.indoorsRouteSymbolHighlight=l.indoorsRouteSymbol.clone(),l.indoorsRouteSymbolHighlight.color=[252,236,52,1],l.indoorsRouteSymbolHighlight.width=10,l.indoorsEventSymbolHighlight=new y({color:[252,236,52,1],style:"circle",size:28,outline:{color:[51,51,51,1],width:2}}),l.set("routeSymbol",new w({color:[0,94,149,1],width:7,cap:"round",join:"round"})),s.first=new y({color:[255,255,255,1],size:19,outline:{color:[51,51,51,1],width:3}}),s.middle=new y({color:[255,255,255,1],size:12,outline:{color:[72,72,72,1],width:3}});s.last=new m({width:23,height:23,url:"data:image/svg+xml;base64,"+btoa('<svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><path d="M15.15.3C6.9.3.3 6.9.3 15.15S6.9 29.7 15.15 29.7 29.7 23.1 29.7 15.15C29.7 6.9 23.25.3 15.15.3z" fill="#333"/><path d="M15 4.8C9.3 4.8 4.8 9.45 4.8 15c0 5.55 4.65 10.2 10.2 10.2 5.55 0 10.2-4.5 10.2-10.2 0-5.55-4.5-10.2-10.2-10.2z" fill="#FFFFFF"/><path fill="#333" d="M10.5 10.5h9v9h-9z"/></g></svg>')}),o(l.get("_routeLayer")),o(l.get("_highlightLayer"),!0,!1),o(l.get("_stopLayer"),!1,!0);var u=l.get("_routeLayer");u&&(u.title="indoorsRouteGraphicsLayer");var d=l.get("_highlightLayer");d&&(d.title="indoorsHighlightGraphicsLayer");var h=l.get("_stopLayer");h&&(h.title="indoorsStopGraphicsLayer"),this.clearWatchHandles(),this.watchHandles.push(l.watch("error",function(e,t,r,i){e&&(console.warn("Directions error:"),console.error(e))}));var p=this;this.watchHandles.push(l.watch("lastRoute",function(e,t,r,i){if(l.lastRoute){var o=[];p.directions._stops&&p.directions._stops.forEach(function(e){var t=e.result.feature;if(!t.xtnSource&&"number"==typeof e.result.sourceIndex){var r=c[e.result.sourceIndex];if(r){var i=a.aiim.datasets.categories.findSourceByKey(r.aiimKey);i&&(t.xtnSource=i)}}o.push(t)});try{if(0<o.length&&a.uiMode.isTouch&&n.directions._activeStop){var s=n.directions._stopsToSearches.get(n.directions._activeStop);s&&s.blur()}}catch(e){console.error("DirectionsPanel:: input blur error:",e)}}})),setTimeout(function(){g.reorderLocationGraphicLayers()},1e3)}}},e.prototype.print=function(){var e=this.directions.viewModel,t=e.indoorsRouteResult,r=e.lastRoute,i=null,o=[];r&&r.routeResults&&(i=r.routeResults[0].directions,o=r.routeResults[0].stops.slice(0)),new n.default({lastRoute:r,directions:i,stops:o,routeResult:t,routeParameters:e.routeParameters,serviceDescription:e.serviceDescription}).print()},e.prototype.render=function(){var e=f.default.getInstance(),t=e.i18n;this.check();var r=null,i=null;this.directions&&(r=this.directions.viewModel,i=this.directions.render());var o=null;if((this.hasServiceUrl||this.hasSources)&&this.hasServiceUrl?this.hasSources||(o=t.messages.noSearchCategories):o=t.messages.noNetworkService,null!==o)return l.tsx("div",{class:u},l.tsx("p",{class:S},o));var s=this.hasPrintTask&&r&&r.lastRoute;return s=s&&e.views.activeView&&"2d"===e.views.activeView.type,e.uiMode.isAndroid&&(s=!1),l.tsx("div",{class:u},l.tsx("div",{class:d},l.tsx("button",{type:"button",bind:this,class:p,onclick:this.print,disabled:!s,"aria-label":t.directions.printTooltip},t.directions.print),l.tsx("button",{type:"button",bind:this,class:h,onclick:this.reset,"aria-label":t.directions.resetTooltip},t.directions.reset)),i)},e.prototype.reset=function(){this.clearWatchHandles();var e=[],t=this.directions;if(t){var r=t.view,i=t.viewModel;i&&(i.clearResults(),e.push(i.get("_routeLayer")),e.push(i.get("_highlightLayer")),e.push(i.get("_stopLayer"))),i=null,t.destroy(),this.directions=null,e.forEach(function(e){try{e&&(e.graphics.removeAll(),r&&r.map&&r.map.remove(e))}catch(e){console.log("Error removing directions graphics layer."),console.error(e)}})}},e.prototype.setupTarget=function(e){var t=this,r=!!this.directions;r&&this.reset(),this.check();var i=f.default.getInstance().layout.sidebar;if(i.activeItem!==i.directionsItem?i.buttonClicked(i.directionsItem):r&&this.renderNow(),this.directions&&this.directions.viewModel){var o=this.directions.viewModel,s=function(){setTimeout(function(){t.setupTargetStop(e)},100)};if("ready"===o.state)s();else{var n=null;n=o.watch("state",function(e,t,r,i){"ready"===e&&(n.remove(),n=null,s())}),setTimeout(function(){n&&(n.remove(),n=null)},1e4)}}},e.prototype.setupTargetStop=function(e){var t=this.directions;if(t){var r=t._stops.getItemAt(1),i=t._stopsToSearches.get(r),o=e.name;r.result=e,r.result.feature.attributes.Name=o,i.searchTerm=o,i.viewModel._set("selectedResult",r.result),t._processStops(),t.scheduleRender(),this.setupHomeStop(e)}},e.prototype.setupHomeStop=function(e){if(f.default.getInstance().isKiosk){var t=null,r=f.default.getInstance().session.referenceLayer;if(r){var i=r.homeLocation;if(i&&i.isValid()){var o=i.searchResult,s=e;if(o&&o.feature&&o.feature.geometry&&s&&s.feature&&s.feature.geometry)o.feature.geometry===s.feature.geometry||(t=o)}}var n=this.directions;if(n&&t){var a=n._stops.getItemAt(0),c=n._stopsToSearches.get(a),l=t.name;a.result=t,a.result.feature.attributes.Name=l,c.searchTerm=l,c.viewModel._set("selectedResult",a.result),n._processStops(),n.scheduleRender()}}},e=o([c.subclass("app.route.DirectionsPanel")],e)}(c.declared(r));t.default=b});