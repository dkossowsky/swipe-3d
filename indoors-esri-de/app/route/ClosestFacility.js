var __extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,i){var o,n=arguments.length,a=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var s=e.length-1;0<=s;s--)(o=e[s])&&(a=(n<3?o(a):3<n?o(t,r,a):o(t,r))||a);return 3<n&&a&&Object.defineProperty(t,r,a),a};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","esri/core/tsSupport/assignHelper","../context/Context","./Util","../aiim/util/aiimUtil","esri/core/Accessor","esri/core/accessorSupport/decorators","esri/geometry/geometryEngine","esri/tasks/support/FeatureSet","esri/request","esri/core/promiseUtils","esri/geometry/support/scaleUtils"],function(e,t,r,i,o,n,a,d,s,c,v,u,l,f,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p=function(o){function e(e){var t=o.call(this,e)||this;t.defaultCutoff=1e3,t.defaultTargetFacilityCount=1e3,t.distanceUnits="esriNAUFeet",t.proximityMaxItemsToSort=10,t.proximityMetersPerLevel=40,t.serviceDistanceUnits="esriNAUMeters",t.serviceTimeUnits="esriNAUMinutes",t.timeAttributeName="WalkTime",t.util=new a.default;var r=n.default.getInstance().config,i=r.proximityMaxItemsToSort;return"number"==typeof i&&0<i&&(t.proximityMaxItemsToSort=i),"number"==typeof(i=r.proximityMetersPerLevel)&&(t.proximityMetersPerLevel=i),t}return r(e,o),e.prototype.cleanItems=function(e){e.forEach(function(e){delete e.distance,delete e.hasEucledianDistance,delete e.eucledianDistance,delete e.cfInfo})},e.prototype.euclideanSort=function(e,t,s){Date.now();var c=!1,u=this.proximityMetersPerLevel,l=e.geometry,f=null,p=null;if(l&&l.spatialReference){var r=l.spatialReference;"number"==typeof(p=m.getMetersPerUnit(r))&&!isNaN(p)&&isFinite(p)||(console.warn("ClosestFacility - Invalid metersPerUnit:",p,", for spatialReference:",r),p=null),"point"===l.type&&l.hasZ?f=l:"polygon"===l.type&&l.centroid&&l.centroid.hasZ&&(f=l.centroid)}var y=null;s&&("number"==typeof(y=d.getAttributeValue(e.attributes,s))&&!isNaN(y)&&isFinite(y)||(s=null)),t.forEach(function(e){var t=e.feature,r=t.geometry;if(l&&r){var i=null,o=null;if(f&&("point"===r.type&&r.hasZ?o=r:"polygon"===r.type&&r.centroid&&r.centroid.hasZ&&(o=r.centroid)),f&&o?i=Math.sqrt(Math.pow(o.x-f.x,2)+Math.pow(o.y-f.y,2)+Math.pow(o.z-f.z,2)):(i=v.distance(l,r,"meters"),"number"==typeof p&&(i*=p)),"number"==typeof i&&!isNaN(i)&&isFinite(i)){if(s){var n=d.getAttributeValue(t.attributes,s);if("number"==typeof n&&!isNaN(n)&&isFinite(n)){var a=Math.abs(y-n);0<a&&(i+=a*u)}}c=!0,e.hasEucledianDistance=!0,e.eucledianDistance=i}}}),c&&t.sort(function(e,t){if(e.hasEucledianDistance&&t.hasEucledianDistance){var r=e.eucledianDistance,i=t.eucledianDistance;if(r<i)return-1;if(i<r)return 1}else{if(e.hasEucledianDistance)return-1;if(t.hasEucledianDistance)return 1}return 0})},e.prototype.facilitiesFromFeatureItems=function(e){var t=[];e.forEach(function(e){t.push(e.feature)});var r=new u({features:t}).toJSON();return r.type="features",r.doNotLocateOnRestrictedElements=!0,JSON.stringify(r)},e.prototype.getSolveUrl=function(){var e=this.getServiceUrl();return e&&(e+="/solveClosestFacility"),e},e.prototype.getServiceUrl=function(){var e=n.default.getInstance().config.closestFacilityServiceUrl;return e&&(e=n.default.checkMixedContent(e)),e},e.prototype.incidentFromFeature=function(e){if(e){var t;if(e.geometry&&"polygon"===e.geometry.type&&e.geometry.centroid){var r=e.clone(),i=r.geometry.centroid;r.geometry=i,d.removeShapeAttributes(r.attributes),t=new u({features:[r]})}else t=new u({features:[e]});var o=t.toJSON();return o.type="features",o.doNotLocateOnRestrictedElements=!0,JSON.stringify(o)}},e.prototype.networkSort=function(e,t){var r=this,i=this.incidentFromFeature(e),o=this.facilitiesFromFeatureItems(t),n=this.solve(i,o);return n.then(function(){r.sort(t,r.results)}),n},e.prototype.solve=function(e,t){var c=this,u=(Date.now(),this.results=[]),r=this.defaultCutoff,i=this.defaultTargetFacilityCount,o=this.getSolveUrl();if("string"!=typeof o||0===o.length)return f.resolve();if(!e)return f.resolve();var n={f:"json",returnFacilities:!0,returnCFRoutes:!0,returnDirections:!1,returnIncidents:!1,returnBarriers:!1,returnPolygonBarriers:!1,returnPolylineBarriers:!1,returnZ:!1,useHierarchy:!1,defaultCutoff:r,defaultTargetFacilityCount:i,outputLines:"esriNAOutputLineNone",travelDirection:"esriNATravelDirectionToFacility",incidents:e};t&&(n.facilities=t);var a={query:n,method:"post",responseType:"json"};return this.readServiceInfo().then(function(){return l(o,a)}).then(function(e){var s=[];e&&e.data&&e.data.facilities&&e.data.facilities.features&&(s=e.data.facilities.features),e&&e.data&&e.data.routes&&e.data.routes.features&&e.data.routes.features.forEach(function(e){if(e.attributes){var t=d.getAttributeValue(e.attributes,"FacilityID"),r=s[t-1];if(r){d.getAttributeValue(e.attributes,"Name");var i=d.getAttributeValue(r.attributes,"Name"),o=d.getAttributeValue(r.attributes,"SourceID"),n="Total_"+c.timeAttributeName,a={facilityName:i,objectId:d.getAttributeValue(r.attributes,"ObjectID"),sourceId:o,sourceOid:d.getAttributeValue(r.attributes,"SourceOID"),facilityRank:d.getAttributeValue(e.attributes,"FacilityRank"),travelTime:d.getAttributeValue(e.attributes,n)};u.push(a)}else console.warn("ClosestFacility - No matching facility for FacilityID:",t)}})}).catch(function(e){console.warn("Error solving closest facility:"),console.error(e)})},e.prototype.readServiceInfo=function(){var i=this,t=function(e){var t={routeParameters:{travelMode:null,directionsTimeAttribute:null},serviceDescription:e},r=i.util.getDirectionsTimeAttribute(t);r&&(r.name&&(i.timeAttributeName=r.name),r.units&&(i.serviceTimeUnits=r.units)),i.serviceDistanceUnits=e.directionsLengthUnits},r=n.default.getInstance().session;if(r.cfServiceDescription)return t(r.cfServiceDescription),f.resolve();var e=this.getServiceUrl();return"string"!=typeof e||0===e.length?f.resolve():d.readServiceJson(e).then(function(e){e&&e.data&&(r.cfServiceDescription=e.data,t(r.cfServiceDescription))})},e.prototype.sort=function(e,i){var o=this,n=!1;if(i&&0<i.length){var a=-1;e.forEach(function(t){a++;t.feature;var r=a+1;"number"==typeof r&&i.some(function(e){if(r===e.objectId)return t.proximity=o.util.formatCFTime(e.travelTime,o.serviceTimeUnits),t.cfInfo=e,n=!0})})}n&&e.sort(function(e,t){if(e.cfInfo&&t.cfInfo){var r=e.cfInfo.facilityRank,i=t.cfInfo.facilityRank;if(r<i)return-1;if(i<r)return 1}else{if(e.cfInfo)return-1;if(t.cfInfo)return 1}return 0})},i([c.property()],e.prototype,"defaultCutoff",void 0),i([c.property()],e.prototype,"defaultTargetFacilityCount",void 0),i([c.property()],e.prototype,"distanceUnits",void 0),i([c.property()],e.prototype,"proximityMaxItemsToSort",void 0),i([c.property()],e.prototype,"proximityMetersPerLevel",void 0),i([c.property()],e.prototype,"serviceDistanceUnits",void 0),i([c.property()],e.prototype,"serviceTimeUnits",void 0),i([c.property()],e.prototype,"timeAttributeName",void 0),e=i([c.subclass("app.route.ClosestFacility")],e)}(c.declared(s));t.default=p});