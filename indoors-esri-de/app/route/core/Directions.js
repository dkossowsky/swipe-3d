var __extends=this&&this.__extends||function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])};return function(e,t){function s(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}}(),__assign=this&&this.__assign||Object.assign||function(e){for(var t,s=1,r=arguments.length;s<r;s++)for(var i in t=arguments[s])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__decorate=this&&this.__decorate||function(e,t,s,r){var i,o=arguments.length,n=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,s,r);else for(var a=e.length-1;0<=a;a--)(i=e[a])&&(n=(o<3?i(n):3<o?i(t,s,n):i(t,s))||n);return 3<o&&n&&Object.defineProperty(t,s,n),n};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","esri/core/tsSupport/assignHelper","../../context/Context","./DirectionsViewModel","../Steps","./Search","../../aiim/util/hitTest","dojo/aspect","esri/core/accessorSupport/decorators","esri/widgets/support/widget","esri/widgets/Directions","esri/core/Collection","esri/widgets/Directions/support/directionsUtils"],function(e,t,r,i,o,m,n,a,c,l,u,d,g,s,h,S){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p="i-maneuver-events",v="i-maneuver-event",y="esri-directions__maneuver",T="esri-directions__maneuver--active",w="esri-directions__maneuver-costs",b="esri-directions__maneuver-costs-container",M="esri-directions__maneuver-icon",R="esri-directions__cost--cumulative",C="esri-directions__cost--intermediate",x="esri-directions__horizontal-splitter",_="awaiting-view-click-stop",f=function(s){function e(e){var t=s.call(this)||this;return t.indoorsHandles=[],t.steps=null,t._autoStopRemovalDelay=1e3,t.steps=new a.default({directionsWidget:t}),t.indoorsInit(),t}return r(e,s),e.prototype._acquireSearch=function(e){var t=this,s=this.get("viewModel.view");if(this._stopsToSearches.has(e)){var r=this._stopsToSearches.get(e);return r.view=s,this._overrideDefaultSources(r),r}var i=new c.default(o({indoorsDirections:this,view:s,resultGraphicEnabled:!1,popupEnabled:!1},this.searchProperties));return this._handles.add([i.watch("defaultSources",function(){return t._overrideDefaultSources(i)}),i.on("select-result",function(){e.result=i.selectedResult,e.result.feature.attributes.Name=i.selectedResult.name,t._processStops(),t.scheduleRender()}),i.on("search-focus",function(){return t._handleStopInputFocus(i,e)}),i.on("search-blur",function(){return t._handleStopInputBlur(i,e)})],i),this._stopsToSearches.set(e,i),i},e.prototype._handleStopInputBlur=function(e,t){var s=this;this._handles.remove(_),this.view.cursor=this._previousCursor,!!e.selectedResult&&!!t.result&&e.selectedResult===t.result||("none"!==e.activeMenu||!e.searchTerm||e.selectedResult===t.result&&(e.selectedResult||t.result)?e.searchTerm||(this._viewClickHandle.resume(),clearTimeout(this._autoStopRemovalTimeoutId),this._autoStopRemovalTimeoutId=setTimeout(function(){s.destroyed||(e.searchTerm||(s._viewClickHandle.pause(),"searching"!==e.viewModel.state&&(console.log("*************** Auto-removing stop..."),s._removeStop(t),!!t.result&&(t.result=null,s._processStops()),s.scheduleRender())))},this._autoStopRemovalDelay)):e.search())},e.prototype._handleViewClick=function(e){var r=this,i=this._stopsToSearches.get(this._activeStop);if(i&&!i.searchTerm){e.stopPropagation(),l.search(this.view,e).then(function(e){if(e&&0<e.length){var t=e[0],s=r._activeStop;s.result=t.searchResult,s.result.feature.attributes.Name=t.caption,i.searchTerm=t.caption,i.viewModel._set("selectedResult",s.result),r._processStops(),r.scheduleRender()}}).catch(function(e){console.log("Mapclick error:"),console.error(e)}),this.scheduleRender()}this._viewClickHandle.pause(),clearTimeout(this._autoStopRemovalTimeoutId)},e.prototype._renderReadyContent=function(){return[this._renderStopsContainer(),this._renderTravelModeOptions(),this.steps.render()]},e.prototype._renderManeuver=function(e){var t,s=m.default.getInstance().i18n,r=e.attributes,i=this.get("viewModel.routeParameters.directionsLengthUnits"),o=S.formatDistance(r.length,{toUnits:i}),n=S.formatTime(r.time),a=S.getAssociatedStop(e);S.useSpatiallyLocalTime(e,this.get("viewModel.routeParameters.startTime"))?t=S.toSpatiallyLocalTimeString(r.arriveTimeUTC,r.ETA,this._departureTime===NOW):o&&(t=n?o+"&nbsp;&middot;<wbr>&nbsp;"+n:o);var c=a,l=this._getFormattedManeuverText(e),u=this._getIconPath(r.maneuverType);if(c)return g.tsx("li",{class:y,key:e},g.tsx("header",null,a.attributes.Name));var d,h="esri-directions__maneuver-"+e.uid,p="esri-directions__cumulative-costs-"+e.uid,v="esri-directions__intermediate-costs-"+e.uid,_=((d={})[T]=this._activeManeuver===e,d),f=this.indoorsRenderManeuverEvents(e);return g.tsx("li",{"aria-labelledby":"${maneuverId} ${cumulativeCostsId} ${intermediateCostsId}",bind:this,class:this.classes(y,_),"data-maneuver":e,key:e,onclick:this._handleManeuverClick,onkeydown:this._handleManeuverClick,onfocus:this._handleManeuverFocus,onmouseover:this._handleManeuverMouseOver,onmouseout:this._handleManeuverMouseOut,onblur:this._handleManeuverBlur,tabIndex:0},g.tsx("img",{alt:s.general.image,class:M,src:u}),g.tsx("div",{class:b},g.tsx("span",{id:h,innerHTML:l}),f,g.tsx("div",{class:w},g.tsx("div",{class:x}),g.tsx("div",{id:p,"aria-label":s.cumulativeCosts,class:R,innerHTML:"",title:s.cumulativeCosts}),g.tsx("div",{id:v,"aria-label":s.intermediateCosts,class:C,innerHTML:t,title:s.intermediateCosts}))))},e.prototype.indoorsClearHandles=function(){this.indoorsHandles.forEach(function(e){try{e.remove()}catch(e){console.log("core/Directions - error removing handle:"),console.error(e)}}),this.indoorsHandles=[]},e.prototype.indoorsInit=function(){var e=this;this._stops=new h([{},{}]),this.viewModel=new n.default,this.indoorsHandles.push(u.after(this,"_handleStopInputFocus",function(){this._viewClickHandle.resume()})),this.indoorsHandles.push(u.after(this,"_handleStopInputBlur",function(){})),this.indoorsHandles.push(u.after(this,"destroy",function(){e.indoorsClearHandles()}))},e.prototype.indoorsRenderManeuverEvents=function(e){var s=[];return e.events&&0<e.events.length&&e.events.forEach(function(e){e.strings&&0<e.strings.length&&e.strings.forEach(function(e){if("esriDSTGeneral"===e.stringType){if("string"==typeof e.string&&0<e.string.length){var t=g.tsx("div",{class:v},e.string);s.push(t)}}else"esriDSTEstimatedArrivalTime"===e.stringType||console.log("*** Unhandled maneuver event string:",e)})}),0<s.length?g.tsx("div",{class:p},s):null},e.prototype.indoorsYourPlaceSelected=function(e){var t=e.getLabel(),s=this._stopsToSearches.get(this._activeStop);s.searchTerm=t;var r=this._activeStop;r.result=e.searchResult,r.result.feature.attributes.Name=t,e.searchResult.name=t,s.viewModel._set("selectedResult",r.result),this._processStops(),this.scheduleRender()},e=i([d.subclass("app.route.core.Directions")],e)}(d.declared(s));t.default=f});