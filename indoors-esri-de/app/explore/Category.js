var __extends=this&&this.__extends||function(){var s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,s){var o,i=arguments.length,n=i<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,s);else for(var a=e.length-1;0<=a;a--)(o=e[a])&&(n=(i<3?o(n):3<i?o(t,r,n):o(t,r))||n);return 3<i&&n&&Object.defineProperty(t,r,n),n};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","../context/Context","../context/Topic","../common//Icons","../aiim/base/ItemReference","../route/ClosestFacility","../aiim/base/SubTypeIcon","../aiim/datasets/FieldNames","../aiim/util/aiimUtil","esri/core/accessorSupport/decorators","esri/widgets/support/widget","esri/widgets/Widget","esri/tasks/support/Query","esri/tasks/QueryTask","esri/core/promiseUtils"],function(e,t,s,o,g,_,i,n,f,a,u,c,l,T,r,p,h,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d="i-category",m="i-category-header",v="i-category-caption-section",b="i-category-caption",x="i-category-subcaption",k="i-icon-button",I="i-category-subtypes",S="i-category-more-button",R="i-icon-working",w="i-feature-items",F="i-feature-item-icon",C="i-feature-item-text",P="i-feature-item-title",M="i-feature-item-subtitle",E="i-feature-item-action",L=function(r){function e(e){var t=r.call(this,e)||this;return t.activeMenu="none",t._activeJob=null,t._wasQueried=!1,t._activeSubType=null,t._hasSubTypes=!1,t._mode="subtypes",t.own(_.default.subscribe(_.default.HomeLocationSet,function(){if(!t._activePromise&&t._resultInfo&&t.getSortByClosest()){var e=t._activeJob={};t.sortResultInfo(e,t._resultInfo)}})),t}return s(e,r),e.prototype.postInitialize=function(){!this.subTypes&&this.source.subCategoryField?this.querySubTypes():this.initMode()},e.prototype.getCFFeature=function(){var e=g.default.getInstance().session.referenceLayer.homeLocation;if(e&&e.isValid())return e.getFeature()},e.prototype.getDisplayField=function(){return this.source.displayField},e.prototype.getSortByClosest=function(){if(!g.default.getInstance().config.closestFacilityServiceUrl)return!1;var e=this._activeSubType;return!(!e||"string"!=typeof e.sortMethod||"closest"!==e.sortMethod.toLowerCase())||!(!(e=this.source)||"string"!=typeof e.sortMethod||"closest"!==e.sortMethod.toLowerCase())},e.prototype.initMode=function(){this.subTypes&&0<this.subTypes.length?this._hasSubTypes=!0:(this._mode,this.queryFeatures())},e.prototype.makeItemReference=function(t){var r=new n.default,e=r.getReferenceProperties(this.source,t.attributes);return r.fromJson(e).then(function(e){return e?y.resolve(r):(console.warn("The item is invalid.",t),_.default.publishErrorAccessingData(),y.resolve(null))}).catch(function(e){return console.warn("Error restoring item:"),console.error(e),y.resolve(null)})},e.prototype.makeResultInfo=function(e){var r={exceededTransferLimit:!1,featureItems:[],voField:null};return e&&e.fields&&(r.voField=c.findFieldName(e.fields,u.default.VERTICAL_ORDER)),e&&e.features&&0<e.features.length&&(r.exceededTransferLimit=e.exceededTransferLimit,e.features.forEach(function(e){var t={feature:e};r.featureItems.push(t)})),r},e.prototype.makeWhere=function(){var e="";if(this._activeSubType){var t=this.source.subCategoryField;if(t)e="("+t+"='"+this._activeSubType.value.replace("'","''")+"')"}return 0===e.length&&(e="1=1"),e},e.prototype.queryFeatures=function(r){var s=this,e=this.getDisplayField(),o=[],t=g.default.checkMixedContent(this.source.url),i=new h({url:t}),n=new p,a=g.default.getInstance().views.mapView;a&&(n.outSpatialReference=a.spatialReference),n.returnGeometry=!0,n.returnZ=!0,n.outFields=["*"],n.where=this.makeWhere(),n.orderByFields=[e],r&&(n.start=this._featureCount,n.num=1e4,this.items&&(o=this.items.slice(0)).pop());var u=this._activePromise=i.execute(n),c=this._activeJob={isQueryFeatures:!0};u.then(function(e){if(u===s._activePromise){s._activePromise=null,s._wasQueried=!0;var t=s.makeResultInfo(e);s._resultInfo=t,e&&e.features&&0<e.features.length?s.sortResultInfo(c,t,o,r):(r||(s.items=null),s._mode="features",s.scheduleRender())}}).catch(function(e){console.warn("Error querying category features:"),console.error(e),u===s._activePromise&&(s._activePromise=null,s._activeJob=null,s.scheduleRender()),_.default.publishErrorAccessingData()})},e.prototype.querySubTypes=function(){var t=this;this.source.subTypesPromise?this.source.subTypesPromise.then(function(){t.subTypes=t.source.subCategories,t.initMode(),t.subTypes&&0<t.subTypes.length&&t.scheduleRender()}).catch(function(e){t.initMode()}):(this.subTypes=this.source.subCategories,this.initMode())},e.prototype.render=function(){var e=null;this._activePromise&&(e=T.tsx("span",{key:"workingIcon",class:R}));var t=null,r=I;return"subtypes"===this._mode?t=this.renderSubTypes():"features"===this._mode&&(r=w,t=this.items),T.tsx("div",{class:d},e,T.tsx("ul",{class:r},t))},e.prototype.renderFeatureItem=function(e,t){var r=this,s=g.default.getInstance().i18n,o="item_"+t,i=e.feature,n=this.source.getTitle(i),a=this.source.getSubTitle(i),u=o+"_span1",c=o+"_span2",l=o+"_span3",p=o+"_span4",f=null;a&&(f=T.tsx("span",{key:l,class:M},a));var h=null,y=null;this._activeSubType&&((y=this._activeSubType.iconUrl)||(y=this.source.iconUrl),y&&(h=T.tsx("img",{class:F,src:y,title:this._activeSubType.name,alt:s.general.image})));var d=null;"string"==typeof e.proximity&&0<e.proximity.length&&(d=T.tsx("span",{class:M},e.proximity));var m="item-action-link-"+t,v=T.tsx("a",{href:"#",key:m,class:E,onclick:function(e){g.default.getInstance().i18n;e.preventDefault(),e.stopPropagation(),r.makeItemReference(i).then(function(e){e&&_.default.publish(_.default.DirectionsClicked,{searchResult:e.searchResult})})},title:s.explore.directionsTooltip,role:"button"},T.tsx("span",{key:p},T.tsx("img",{src:"assets/route.svg"}))),b="item_link_"+t;return T.tsx("li",{key:o},T.tsx("a",{href:"#",key:b,onclick:function(){r.makeItemReference(i).then(function(e){e&&_.default.publish(_.default.ShowSearchResult,{sourceKey:e.sourceKey,searchResult:e.searchResult,zoom:!0,highlight:!0,trackRecent:!0})})}},h,T.tsx("span",{key:u,class:C},T.tsx("span",{key:c,class:P},n),f,d),v))},e.prototype.renderMoreButton=function(){var e=this,t=g.default.getInstance().i18n.explore.category.more;return T.tsx("li",{key:"moreButton"},T.tsx("a",{href:"#",class:S,onclick:function(){e.queryFeatures(!0)}},t))},e.prototype.renderPanelCaption=function(){var e=this,t=g.default.getInstance().i18n,r="";this.source&&(r=this.source.name);var s=null;if("features"===this._mode&&this._activeSubType){var o=this._activeSubType.name;s=T.tsx("span",{key:x,class:x},o)}return T.tsx("div",{key:"i-category-caption",class:m},T.tsx("a",{href:"#",class:k,onclick:function(){"features"===e._mode&&e._hasSubTypes?e._mode="subtypes":e.parentPanel.deactivateCategory()},role:"button",title:t.explore.backButtonTooltip},i.default.back()),T.tsx("span",{key:v,class:v},T.tsx("span",{key:b,class:b},r),s))},e.prototype.renderResultInfo=function(e,r){var s=this,o=-1;e.featureItems.forEach(function(e){o++;var t=s.renderFeatureItem(e,o);r.push(t)}),this._featureCount=r.length,e.exceededTransferLimit&&r.push(this.renderMoreButton()),0===r.length&&(r=null),this.items=r,this._mode="features",this.scheduleRender()},e.prototype.renderSubType=function(e,t){var r=this,s=new a.default({forFeature:!1,source:this.source,subType:e}).render(),o="subType_"+t;return T.tsx("li",{key:o},T.tsx("a",{href:"#",onclick:function(){r._activeSubType=e,r.queryFeatures()},role:"button"},s,T.tsx("p",null,e.name)))},e.prototype.renderSubTypes=function(){var t=this,r=[],s=-1;return this.subTypes&&0<this.subTypes.length&&this.subTypes.forEach(function(e){s++,r.push(t.renderSubType(e,s))}),0<r.length?r:null},e.prototype.sortResultInfo=function(t,r,e,s){var o,i=this,n=function(e){t===i._activeJob&&(i._activeJob=null),e&&(console.warn("Error sorting items by network distance."),console.error(e))},a=this.getSortByClosest(),u=r.featureItems,c=new f.default;if((a=a&&!r.exceededTransferLimit&&!s)&&(c.cleanItems(u),(o=this.getCFFeature())&&1<u.length&&c.euclideanSort(o,r.featureItems,r.voField)),t.isQueryFeatures&&this.renderResultInfo(r,e),a&&o){var l=c.proximityMaxItemsToSort,p=r.featureItems.slice(0,l);0<p.length&&c.networkSort(o,p).then(function(){if(t===i._activeJob){for(var e=0;e<p.length;e++)u[e]=p[e];n(),i.renderResultInfo(r,[])}}).catch(function(e){n(e)})}},o([l.property()],e.prototype,"activeMenu",void 0),o([l.property()],e.prototype,"items",void 0),o([l.property()],e.prototype,"parentPanel",void 0),o([l.property()],e.prototype,"queryResult",void 0),o([l.property()],e.prototype,"source",void 0),o([l.property()],e.prototype,"subTypes",void 0),e=o([l.subclass("app.explore.Category")],e)}(l.declared(r));t.default=L});