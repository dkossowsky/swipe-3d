var __extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,i){var n,s=arguments.length,o=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(o=(s<3?n(o):3<s?n(t,r,o):n(t,r))||o);return 3<s&&o&&Object.defineProperty(t,r,o),o};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","../context/Context","../context/Topic","./DateFilter","./TimeFilter","./TypeFilter","../aiim/datasets/FieldNames","../aiim/base/ItemReference","../aiim/util/aiimUtil","esri/widgets/Widget","esri/core/accessorSupport/decorators","esri/widgets/support/widget","esri/tasks/support/Query","esri/tasks/QueryTask","esri/core/promiseUtils"],function(e,t,i,n,m,v,s,o,a,u,l,c,r,f,y,d,p,h){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var g="i-events",_="i-icon-working",F="i-events-options",k="i-events-items",x="i-category-more-button",w="i-event-item",I="i-event-item-left",R="i-event-item-right",b="i-event-item-month",P="i-event-item-day",D="i-event-item-name",E="i-event-item-timeperiod",O="i-event-item-location",T="i-note i-padded i-font-size-s",A=function(r){function e(e){var t=r.call(this,e)||this;return t._activeJob=null,t._wasQueried=!1,t.dateFilter=new s.default,t.timeFilter=new o.default,t.typeFilter=new a.default,t.own(t.dateFilter.on("changed",function(){t.queryFeatures()})),t.own(t.timeFilter.on("changed",function(){t.queryFeatures()})),t.own(t.typeFilter.on("changed",function(){t.queryFeatures()})),t}return i(e,r),e.prototype.beforeActivate=function(){var e=this.getDataset();e&&(this.queryFeatures(),this.dateFilter.beforeActivate(e),this.timeFilter.beforeActivate(e),this.typeFilter.beforeActivate(e))},e.prototype.getDataset=function(){var e=m.default.getInstance().aiim.datasets.events;return e&&e.url?e:null},e.prototype.makeItemReference=function(t){var e=this.getDataset(),r=new l.default,i=r.getReferenceProperties(e.getSource(),t.attributes);return r.fromJson(i).then(function(e){return e?h.resolve(r):(console.warn("The item is invalid.",t),v.default.publishErrorAccessingData(),h.resolve(null))}).catch(function(e){return console.warn("Error restoring item:"),console.error(e),h.resolve(null)})},e.prototype.makeResultInfo=function(e){var r={exceededTransferLimit:!1,featureItems:[],voField:null};return e&&e.fields&&(r.voField=c.findFieldName(e.fields,u.default.VERTICAL_ORDER)),e&&e.features&&0<e.features.length&&(r.exceededTransferLimit=e.exceededTransferLimit,e.features.forEach(function(e){var t={feature:e};r.featureItems.push(t)})),r},e.prototype.makeWhere=function(){var e=function(e,t){return"string"==typeof t&&0<t.length&&(0<e.length&&(e+=" AND "),e+=t),e},t="",r={},i=this.getDataset();return i&&(t=e(t=e(t=e(t,this.dateFilter.makeWhere(r,i)),this.timeFilter.makeWhere(r,i)),this.typeFilter.makeWhere(r,i))),0===t.length&&(t="1=1"),t},e.prototype.processResultInfo=function(e,t,r,i){this.renderResultInfo(e,t,r)},e.prototype.queryFeatures=function(r){var i=this,e=this.getDataset();if(e){var n=[],t=m.default.checkMixedContent(e.url),s=e.dateStartField,o=m.default.getInstance().views.mapView,a=new p({url:t}),u=new d;u.returnGeometry=!0,u.returnZ=!0,u.outFields=["*"],u.where=this.makeWhere(),s&&(u.orderByFields=[s]),o&&(u.outSpatialReference=o.spatialReference),r&&(u.start=this._featureCount,u.num=1e4,this.items&&(n=this.items.slice(0)).pop());var l=this._activePromise=a.execute(u),c=this._activeJob={dataset:e,isQueryFeatures:!0};l.then(function(e){if(l===i._activePromise){i._activePromise=null,i._wasQueried=!0;var t=i.makeResultInfo(e);i._resultInfo=t,e&&e.features&&0<e.features.length?i.processResultInfo(c,t,n,r):(r||(i.items=null),i.scheduleRender())}}).catch(function(e){console.warn("Error querying Events:"),console.error(e),l===i._activePromise&&(i._activePromise=null,i._activeJob=null,i.scheduleRender()),v.default.publishErrorAccessingData()})}},e.prototype.render=function(){if(!this.getDataset())return null;var e=m.default.getInstance().i18n,t=null,r=null;this._activePromise&&(r=y.tsx("span",{key:"workingIcon",class:_}));var i=this.renderOptions();return this.items&&0<this.items.length?t=y.tsx("ul",{class:k},this.items):r||(t=y.tsx("p",{role:"alert",class:T},e.events.noMatch)),y.tsx("div",{class:g},i,r,t)},e.prototype.renderFeatureItem=function(e,t,r){var i=this,n=(m.default.getInstance().i18n,t.feature),s="item_"+r,o=s+"_a",a=s+"_left",u=a+"_1",l=a+"_2",c=s+"_right",f=c+"_1",d=c+"_2",p=c+"_3",h=e.dataset.getEventInfo(e,n);return y.tsx("li",{key:s},y.tsx("a",{href:"#",key:o,class:w,onclick:function(){i.makeItemReference(t.feature).then(function(e){e&&v.default.publish(v.default.ShowSearchResult,{sourceKey:e.sourceKey,searchResult:e.searchResult,zoom:!0,highlight:!0,trackRecent:!0})})}},y.tsx("div",{key:a,class:I},y.tsx("div",{key:u,class:b},h.mmm),y.tsx("div",{key:l,class:P},h.d)),y.tsx("div",{key:c,class:R},y.tsx("div",{key:f,class:D},h.name),y.tsx("div",{key:d,class:E},h.timePeriod),y.tsx("div",{key:p,class:O},h.location))))},e.prototype.renderMoreButton=function(){var e=this,t=m.default.getInstance().i18n;return y.tsx("li",{key:"moreButton"},y.tsx("a",{href:"#",class:x,onclick:function(){e.queryFeatures(!0)}},t.explore.category.more))},e.prototype.renderOptions=function(){var e=m.default.getInstance().uiMode,t=F;return e.isIOS&&e.isTouch&&(t+=" i--short"),y.tsx("div",{key:"options",class:t},this.dateFilter.render(),this.timeFilter.render(),this.typeFilter.render())},e.prototype.renderResultInfo=function(r,e,i){var n=this,s=-1;e.featureItems.forEach(function(e){s++;var t=n.renderFeatureItem(r,e,s);i.push(t)}),this._featureCount=i.length,e.exceededTransferLimit&&i.push(this.renderMoreButton()),0===i.length&&(i=null),this.items=i,this.scheduleRender()},n([f.property()],e.prototype,"dateFilter",void 0),n([f.property()],e.prototype,"items",void 0),n([f.property()],e.prototype,"timeFilter",void 0),n([f.property()],e.prototype,"typeFilter",void 0),e=n([f.subclass("app.events.EventsPanel")],e)}(f.declared(r));t.default=A});