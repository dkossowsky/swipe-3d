var __extends=this&&this.__extends||function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,i,r){var l,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(l=e[o])&&(a=(n<3?l(a):3<n?l(t,i,a):l(t,i))||a);return 3<n&&a&&Object.defineProperty(t,i,a),a};define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","esri/core/tsSupport/assignHelper","../context/Context","../context/Topic","../aiim/base/Floors","esri/core/accessorSupport/decorators","esri/widgets/support/widget","esri/widgets/Widget","esri/widgets/Expand"],function(e,t,r,l,i,a,o,s,n,d,c,v){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p="i-floorfilter",f="i-floorfilter-caption",u="i-floorfilter-list",w="i-icon-expand-none",L=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t=l([n.subclass("app.map.FloorFilterExpand")],t)}(n.declared(v)),_=function(i){function e(e){var t=i.call(this,e)||this;return t.extentLevelList=["wildcard"],t.wildcard=a.default.getInstance().i18n.floorFilter.wildcard,t._activeLevel=null,t._deferredAction=null,t._dfdLabel=null,t._ignoreAppStarted=!1,t}return r(e,i),e.prototype.postInitialize=function(){var n=this;this.view&&this.own(this.view.watch("extent",function(e,t){n.queryLevelsByExtent()})),this.own(o.default.subscribe(o.default.AppStarted,function(e){!!a.default.getInstance().aiim.datasets.levels||n.expander&&n.view&&n.view.ui.remove(n.expander),n._ignoreAppStarted||n.queryLevelsByExtent()})),this.own(o.default.subscribe(o.default.AfterSetLevel,function(e){var t="2d"===n.view.type,i=e.level;n.view===e.view?(n._activeLevel=i,n.setExpanderLabel(i),t&&(a.default.getInstance().session.active2DLevel=i)):!t&&e.forRoute||(n._deferredAction={action:"setLevel",level:i})})),this.own(o.default.subscribe(o.default.AfterSetLevelFromFeatures,function(e){var t="2d"===n.view.type,i=n.wildcard,r=n.wildcard;1===e.levels2D.length&&(i=e.levels2D[0]),1===e.levels3D.length&&(r=e.levels3D[0]);var l=i;t||(l=r),n.view===e.view?t&&i===n.wildcard||t&&e.stats&&e.stats.forRoute||(n._activeLevel="__implicit__",n.setExpanderLabel(l)):t&&i===n.wildcard?n._deferredAction=null:t&&e.stats&&e.stats.forRoute?n._deferredAction={action:"setLevel",level:l}:n._deferredAction={action:"setLevelFromStats",level:l,stats:e.stats}})),this.own(o.default.subscribe(o.default.AfterResetLevel,function(e){var t="2d"===n.view.type,i=n.wildcard;n.view===e.view?(t&&(i=e.level),n._activeLevel=i,n.setExpanderLabel(i)):t?(i=a.default.getInstance().session.active2DLevel,n._deferredAction=null!=i?{action:"setLevel",level:i}:null):n._deferredAction={action:"resetLevel",level:i}})),this.own(o.default.subscribe(o.default.ViewActivated0,function(e){if(n.view&&n.view===e.view&&n._deferredAction){var t="2d"===e.view.type,i=n._deferredAction;if(n._deferredAction=null,"setLevel"===i.action){var r=i.level;if(t&&(a.default.getInstance().session.active2DLevel=r),n._activeLevel!==r)n._activeLevel=r,n.setExpanderLabel(r),(new s.default).setLevel(n.view,r)}else if("setLevelFromStats"===i.action){t&&(a.default.getInstance().session.active2DLevel=i.level),n._activeLevel="__implicit__",n.setExpanderLabel(i.level);new s.default;if(i.stats)(new s.default).setLevelFromStats(n.view,i.stats)}else if("resetLevel"===i.action){r=i.level;if(n._activeLevel!==r)n._activeLevel=r,n.setExpanderLabel(r),(new s.default).resetLevel(n.view)}}}))},e.prototype.queryLevelsByExtent=function(){var i=this;if(this.view&&this.view.extent&&a.default.getInstance().layout){this._ignoreAppStarted=!0;var e=this._tmpFloors=new s.default;setTimeout(function(){e===i._tmpFloors&&e.queryLevelsByExtent(i.view).then(function(e){if(e&&Array.isArray(e.extentLevelList)){var t=["wildcard"].concat(e.extentLevelList);i.extentLevelList=t}}).catch(function(e){console.warn("Error querying Levels for this extent:"),console.error(e)})},100)}},e.prototype.render=function(){var t=this,e=a.default.getInstance().i18n,i=this.extentLevelList.map(function(e){return t.renderLevel(e)});return d.tsx("div",{class:p},d.tsx("div",{class:f},e.floorFilter.caption),d.tsx("ul",{class:u},i))},e.prototype.renderLevel=function(e){var t=this,i="wildcard"===e;if(i&&this.view&&"2d"===this.view.type)return null;var r=e.levelNumber,l=i?this.wildcard:""+e.levelShortName,n=this.id+"_"+e.levelNumber;return d.tsx("li",{key:n},d.tsx("a",{href:"javascript:void(0)",onclick:function(){t.expander&&(t.expander.expandTooltip=l,t.expander.collapseTooltip=l,t.expander.collapse());var e=new s.default;i?(t._activeLevel="wildcard",e.resetAll(t.view)):(t._activeLevel=r,e.setLevel(t.view,r))}},l))},e.prototype.setExpanderLabel=function(t){var i=this,r=function(e){i._dfdLabel=null,"string"==typeof e&&0!==e.length||(e=""+t),i.expander&&(i.expander.expandTooltip=e,i.expander.collapseTooltip=e)};if("wildcard"===t||"*"===t)r(this.wildcard);else if("number"==typeof t){var e=a.default.getInstance().aiim.datasets.levels;if(e){var l=this._dfdLabel=e.getShortName(t);l.then(function(e){l===i._dfdLabel&&r(e),i._dfdLabel=null}).catch(function(e){i._dfdLabel=null,console.warn("Error getting level name:"),console.error(e)})}}else r("?")},e.prototype.setupExpander=function(){return this._activeLevel="wildcard",this.expander=new L({view:this.view,content:this,expandTooltip:this.wildcard,collapseTooltip:this.wildcard,expandIconClass:w,group:"map-tools"}),this.expander},l([n.property()],e.prototype,"expander",void 0),l([n.property(),d.renderable()],e.prototype,"extentLevelList",void 0),l([n.property()],e.prototype,"view",void 0),l([n.property()],e.prototype,"wildcard",void 0),e=l([n.subclass("app.map.FloorFilter")],e)}(n.declared(c));t.default=_});