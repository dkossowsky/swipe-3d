define(["require","exports","esri/core/tsSupport/declareExtendsHelper","esri/core/tsSupport/decorateHelper","esri/core/tsSupport/assignHelper","../context/Context","./Compass","./core/CustomLayerList","./LevelFilter","../context/Topic","./ViewToggle","dojo/aspect","dojo/_base/fx","esri/portal/PortalItem","esri/core/promiseUtils","esri/WebMap","esri/WebScene","esri/views/MapView","esri/views/SceneView","esri/widgets/Home","esri/widgets/Expand","esri/widgets/BasemapGallery"],function(e,i,t,a,n,w,u,d,m,p,v,o,r,c,l,s,f,V,h,y,g,b){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var k=function(){function e(){this.mapClickDisabled=!1}return e.prototype.addWidgets=function(e){var i=this,t=w.default.getInstance().i18n;e.ui.remove("compass");var a=new u.default({view:e});e.ui.add({component:a,position:"top-left",index:0});var n=new y({view:e});e.ui.add(n,"top-left");var o=new b({view:e,container:document.createElement("div")}),r=new g({view:e,content:o,expandIconClass:"esri-icon-basemap",expandTooltip:t.map.basemapGallery.tip,collapseTooltip:t.map.basemapGallery.collapse,group:"map-tools"});e.ui.add(r,"top-left"),this.watchBasemapGallery(e,o,r);var c=new d.default({view:e,listItemCreatedFunction:function(e){var i=e&&e.item;i&&i.layer&&"esri.layers.MapImageLayer"===i.layer.declaredClass&&(i.open||(i.open=!0))}}),p=new g({view:e,content:c,expandIconClass:"esri-icon-layer-list",expandTooltip:t.map.layerList.tip,collapseTooltip:t.map.layerList.collapse,group:"map-tools"});e.ui.add(p,"top-left");var l=new v.default({view:e});l.on("clicked",function(e){i.toggleView()}),e.ui.add(l,"top-left");var s=new m.default({view:e});e.ui.add(s,"top-right")},e.prototype.getInactiveView=function(){return this.activeView===this.mapView?this.sceneView:this.activeView===this.sceneView?this.mapView:null},e.prototype.load=function(){var c=this;return l.create(function(e,i){var t=w.default.getInstance().config,a=t.webmap,n=t.webscene,o=document.getElementById("view-container"),r=document.createElement("div");o.appendChild(r),c.loadWebMap(a).then(function(e){return c.makeMapView(e,null),c.loadWebScene(n)}).then(function(e){if(c.makeSceneView(e,null),!c.activeView&&c.mapView&&(c.activeView=c.mapView,c.activeView.container=r),!c.activeView&&c.sceneView&&(c.activeView=c.sceneView,c.activeView.container=r),c.mapView&&!c.sceneView&&c.removeViewToggle(c.mapView),!c.mapView&&c.sceneView&&c.removeViewToggle(c.sceneView),c.activeView)return c.activeView.when()}).then(function(){c.activeView&&p.default.publish(p.default.ViewActivated,{view:c.activeView}),e()}).catch(function(e){i(e)})})},e.prototype.loadItem=function(e){return new c({id:e}).load()},e.prototype.loadWebMap=function(e){return e?new s({portalItem:{id:e}}).load():l.reject(new Error("No webmap was specified"))},e.prototype.loadWebScene=function(e){return e&&w.default.getInstance().supports3D?new f({portalItem:{id:e}}).load():l.resolve(null)},e.prototype.makeMapView=function(e,i){if(!e)return null;var t=this,a=new V({map:e,container:i,popup:null});return this.mapView=a,this.addWidgets(a),a.on("click",function(e){t.mapClickDisabled||p.default.publish(p.default.ViewClicked,{view:a,event:e})}),a},e.prototype.makeSceneView=function(e,i){if(!e)return null;var t=this,a=new h({map:e,container:i,popup:null});return this.sceneView=a,this.addWidgets(a),a.on("click",function(e){t.mapClickDisabled||p.default.publish(p.default.ViewClicked,{view:a,event:e})}),a},e.prototype.removeViewToggle=function(e){var i=null;e.ui._components.some(function(e){if(e.widget&&e.widget.isViewToggle)return i=e,!0}),i&&e.ui.remove(i)},e.prototype.toggleView=function(){var t=this;if(this.activeView&&this.mapView&&this.sceneView){var a=this,n=document.getElementById("view-container"),o=this.activeView.container;if("2d"===this.activeView.type){var i=this.mapView.viewpoint.clone(),e={node:n,onEnd:function(){var e={node:n,onEnd:function(){}};setTimeout(function(){a.mapView.container=null,a.sceneView.container=o,a.activeView=a.sceneView,a.sceneView.viewpoint=i,p.default.publish(p.default.ViewActivated0,{view:a.activeView}),p.default.publish(p.default.ViewActivated,{view:a.activeView}),r.fadeIn(e).play()},400)}};r.fadeOut(e).play()}else{this.sceneView.goTo({heading:0,tilt:0}).then(function(){var i=t.sceneView.viewpoint.clone(),e={node:n,onEnd:function(){var e={node:n,onEnd:function(){a.mapView===a.activeView&&a.mapView.map&&a.mapView.map.layers&&a.mapView.map.layers.forEach(function(e){try{"map-image"===e.type&&e.visible&&"function"==typeof e.refresh&&e.refresh()}catch(e){console.warn("Error refreshing map-image"),console.error(e)}})}};setTimeout(function(){a.sceneView.container=null,a.mapView.container=o,a.mapView.viewpoint=i,a.activeView=a.mapView,p.default.publish(p.default.ViewActivated0,{view:a.activeView}),p.default.publish(p.default.ViewActivated,{view:a.activeView}),r.fadeIn(e).play()},200)}};r.fadeOut(e).play()}).catch(function(e){console.warn("Error switching to 2D view:"),console.error(e)})}}},e.prototype.watchBasemapGallery=function(t,e,a){var n=this;o.after(e,"_handleClick",function(e){if(!e||"keydown"!==e.type||13==e.keyCode||32==e.keyCode){var i=e.currentTarget["data-item"];i&&"ready"===i.state&&(t===n.mapView?n.sceneView&&(n.sceneView.map.basemap=i.basemap):t===n.sceneView&&n.mapView&&(n.mapView.map.basemap=i.basemap),a.collapse())}},!0)},e}();i.default=k});